---
title: "SNP Analysis"
author: "Sarah Killcoyne"
date: "6/13/2018"
output: html_document
---

```{r setup, include=FALSE}
library(ggplot2)
library(gridExtra)
library(glmnet)
library(pander)
library(readxl)
library(pROC)

source('lib/data_func.R')
source('lib/common_plots.R')


plot.sample<-function(segs, mer)


chr.info = get.chr.lengths(file='hg19_info.txt')

#ptdirs = list.dirs('/Volumes/fh/fast/reid_b/collab/Killcoyne/Data/PerPatient', full.names=T, recursive=F)
#patients = basename(ptdirs)

load('~/Data/Ellie/Analysis/5e6_arms_all_logR/model_data.Rdata', verbose = T)
load('~/Data/Ellie/Analysis/5e6_arms_all_logR/all.pt.alpha.Rdata', verbose = T)
fitV = models$`0.9`
l = performance.at.1se$`0.9`$lambda

swgs_labels = labels

rm(plots,performance.at.1se,models,cvs,labels)

pv = var(dysplasia.df[swgs_labels == 1])  # P
npv = var(dysplasia.df[swgs_labels == 0]) # NP

range(dysplasia.df[swgs_labels == 1])
range(dysplasia.df[swgs_labels == 0])

load('~/Data/Reid_SNP/PerPatient/allpts_ascat.Rdata', verbose=T)

patient.info = as.data.frame(read_xlsx('~/Data/Ellie/Analysis/SNP/metadata_T1T2.xlsx'))
patient.info$UniqueSampleID = paste(patient.info$PatientID, patient.info$`Timepoint Code`, sep='_')
patient.info$Path.Status = patient.info$Status
patient.info[patient.info$PatientID %in% subset(patient.info, Pathology %in% c('IMC','HGD'), select='PatientID')[,1], 'Path.Status'] = 'P'


sample.list = read_xlsx('~/Data/Ellie/Analysis/SNP/20180604_Reid_1M_SampleList.xlsx', sheet = 2)
nrow(sample.list)
colnames(sample.list)[3] = 'Total.SCA'

sample.list$SCA.Ratio = sample.list$Total.SCA/max(chr.info$genome.length)

sample.info  = do.call(rbind.data.frame, sapply(qcdata$Samplename, strsplit, '_'))
colnames(sample.info) = c('PatientID','SampleID','EndoID','Level')
sample.info[] = lapply(sample.info[], as.character)
sample.info[which(sample.info$PatientID == 524 & sample.info$Level == 524), 'Level'] = ''
sample.info$Samplename = qcdata$Samplename

message(paste(length(unique(sample.info$PatientID)), 'patients listed in metadata file'))
message(paste(nrow(qcdata), 'samples available'))

sample.info = base::merge(sample.info, patient.info[,c('PatientID','Timepoint','Timepoint Code','Status','Pathology')], by.x=c('PatientID','EndoID'), by.y=c('PatientID','Timepoint Code'))

get.ratio<-function(PID, SID) {
  subset(sample.list, PatientID == PID & SampleNum == SID)$SCA.Ratio
}

sample.info = sample.info %>% rowwise() %>% dplyr::mutate(
  SCA.Ratio = ifelse(Level %in% c('BLD','GASTRIC'), 0, get.ratio(PatientID, SampleID))
)

```

## Patient info 

```{r, echo=F}

patient.info = patient.info %>% rowwise() %>% dplyr::mutate( Endoscopy = ifelse(Timepoint == 'T1', 1, 2) )

sm = patient.info %>% group_by(Status, Endoscopy, Pathology) %>% dplyr::tally() %>% group_by(Status, Endoscopy) %>% dplyr::mutate(freq=n/sum(n) )
sm$Pathology = factor(sm$Pathology, levels=c('NDBE','ID','LGD','HGD','IMC'), ordered = T)

ggplot(sm, aes(Pathology, freq, group=Endoscopy, fill=factor(Endoscopy))) + facet_grid(~Status) + geom_col(position = position_dodge()) + ylim(0,1) + title('Pathology frequency per timepoint')
```


There's a significant difference in the numbers of NDBE or HGD samples between the groups
```{r}
chisq.test(table(patient.info$Pathology, patient.info$Status)['HGD',])
chisq.test(table(patient.info$Pathology, patient.info$Status)['NDBE',])

# Most progressors are HGD at timepoint 1
with(subset(patient.info, Endoscopy == 1), table(Pathology, Status))['HGD',]/table(subset(patient.info, Endoscopy == 1)$Status)
```




# Quick QC 
In the sWGS data progressor samples show a variance of `r round(pv, 3)` and non-prog variance is `r round(npv,3)`

Purity, ploidy and goodnessoffit from single sample (not paired) ASCAT.

```{r, echo=F, eval=T}
qcdata$SampleType = 'BE'
qcdata$SampleType[grep('BLD',rownames(qcdata), ignore.case=T)] = 'Blood Normal'
qcdata$SampleType[grep('gastric',rownames(qcdata), ignore.case=T)] = 'Gastric Normal'
head(qcdata)

qcdata = base::merge(qcdata, sample.info[,c('Samplename','Status','Timepoint','SCA.Ratio')], by='Samplename')

ggplot(qcdata, aes(round(Ploidy,2))) + geom_histogram() + 
  facet_wrap(~SampleType, scales='free_y', ncol=1) + labs(x='Ploidy', title='Ploidy, normal vs BE')

ggplot(qcdata, aes(Purity, Goodnessoffit, color=Status)) + geom_point() + facet_wrap(~SampleType, ncol=1) + 
  labs(title='Purity~fit, normal vs BE')

ggplot(qcdata, aes(SCA.Ratio)) + geom_histogram() + 
  facet_wrap(~Status, scales='free_y', ncol=1) + labs(x='SCA Ratio', title='SCA Ratio, NP vs P')

ggplot(subset(qcdata, SampleType == 'BE'), aes(Purity, SCA.Ratio, color=Status)) + geom_point() + 
  geom_vline(xintercept = 0.95, color='red') + geom_hline(yintercept = 0.05, color='red') + 
  labs(title='Barretts only')

ggplot(subset(qcdata, SampleType == 'BE'), aes(Ploidy, SCA.Ratio, color=Status)) + geom_point() + 
  geom_hline(yintercept = 0.05, color='red') + labs(title='Barretts only')

## Low CN
lowPloidyCN = subset(qcdata, Status == 'P' & SampleType == 'BE' & SCA.Ratio <= 0.05 & Ploidy <= 2)

## samples have no apparent CN
noCN = subset(qcdata, Status == 'P' & SCA.Ratio <= 0 & SampleType == 'BE')

## high CN | ploidy, nonP
highPloidyCN = subset(qcdata, Status == 'NP' & SampleType == 'BE' & (SCA.Ratio >= mean(qcdata$SCA.Ratio,na.rm=T)+ sd(qcdata$SCA.Ratio,na.rm=T)*2 | Ploidy >= 2.3))

```

#### P: Low SCA, Ploidy<=2
`r round(nrow(lowPloidyCN)/nrow(subset(qcdata, Status == 'P' & SampleType == 'BE')), 3)*100`% of PROGRESSOR samples have <5% SCA and an ASCAT ploidy of 2 or less. Most of these show a >90% purity as well.
`r pander(summary(lowPloidyCN$Purity))`

#### P: No SCA
`r round(nrow(noCN)/nrow(subset(qcdata, Status == 'P' & SampleType == 'BE')), 3)*100`% of PROGRESSOR samples have 0 SCA

#### NP: High CN or ploidy > 2.3
`r round(nrow(highPloidyCN)/nrow(subset(qcdata, Status == 'NP' & SampleType == 'BE')), 3)*100`% of NON-PROGRESSOR samples have >2SD SCA (~25%) or high ploidy.


```{r, echo=F}

qcdata$SCA.Ratio = round(qcdata$SCA.Ratio, 4)

lowsca = subset(qcdata, Status == 'P' & SampleType == 'BE' & SCA.Ratio <= 0.05 & Ploidy <= 2)

totalSamples = table(sub('_.*','', qcdata$Samplename))
lowscaSamples = table(sub('_.*','', lowsca$Samplename))

# For those patients with low SCA samples, a large proportion of them show low SCA in most/all of their samples
#plot(round(lowscaSamples/totalSamples[names(lowscaSamples)], 2))

pt = '403'
pfiles = list.files(paste('~/Data/Reid_SNP/PerPatient', pt, sep='/'), full.names = T)
load(grep('ascat.Rdata', pfiles, value=T), verbose=T)

seg = ascat.output$segments_raw
seg$chr = factor(seg$chr, levels=c(1:22,'X','Y'))
ggplot(seg) + facet_grid(sample~chr, space='free_x', scales='free') + 
  geom_segment(aes(x=startpos, xend=endpos, y=medLRR, yend=medLRR), color='darkgreen', size=3) + 
  theme(axis.text.x=element_blank() ) + labs(title='Low SCA', subtitle='patient 403')

pt = '512'
pfiles = list.files(paste('~/Data/Reid_SNP/PerPatient', pt, sep='/'), full.names = T)
load(grep('ascat.Rdata', pfiles, value=T), verbose=T)

seg = ascat.output$segments_raw
seg$chr = factor(seg$chr, levels=c(1:22,'X','Y'))
ggplot(seg) + facet_grid(sample~chr, space='free_x', scales='free') + 
  geom_segment(aes(x=startpos, xend=endpos, y=medLRR, yend=medLRR), color='darkgreen', size=3) + 
  theme(axis.text.x=element_blank() ) + labs(title='Mixed SCA samples', subtitle='patient 512')

```


# Load tiled data

CN Adjustment uses Annalise's whole-genome non-progressor samples to generate a set of mean and SD values per copy-number state. The median LogR values are adjusted using the mean and SD based on the CN state.  The adjusted LogR values are then winsorize per sample, and tiled in 5Mb bins.

```{r, warning=F, echo=F}

if (file.exists('~/Data/Reid_SNP/PerPatient/tmp_seg_pt.Rdata')) {
  load('~/Data/Reid_SNP/PerPatient/tmp_seg_pt.Rdata', verbose=T) 
} else {

mergedSegs = NULL
mergedArms = NULL
length(ptdirs)

for (pt in ptdirs) {
  print(pt)
  if (length(list.files(pt, '*wins_tiled.txt', full.names=T)) <= 0) {
    message(paste("No tiled files for",pt))
    next
  }

  segvals = as.data.frame(data.table::fread(list.files(pt, '*wins_tiled.txt', full.names=T)))
  armvals = as.data.frame(data.table::fread(list.files(pt, '*arms_tiled.txt', full.names=T)))
  
  segvals = segment.matrix(segvals)
  segvals[is.na(segvals)] = mean(segvals,na.rm=T)
  
  armvals = segment.matrix(armvals)
  armvals[is.na(armvals)] = mean(armvals,na.rm=T)

  if (is.null(segvals) | is.null(armvals))
    stop(paste("Missing values in ", pt))
  
  if (is.null(mergedSegs)) {
    mergedSegs = segvals
    mergedArms = armvals
  } else {
    mergedSegs = rbind(mergedSegs, segvals)    
    mergedArms = rbind(mergedArms, armvals)    
  }
}
nrow(mergedSegs) == nrow(mergedArms)
#setdiff(rownames(mergedSegs), rownames(mergedArms))
dim(mergedSegs)

save(mergedSegs, mergedArms, file='tmp_seg_pt.Rdata')
}
rownames(mergedSegs) = sub('\\.LogR','', rownames(mergedSegs))
rownames(mergedArms) = sub('\\.LogR','', rownames(mergedArms))

## Per endoscopy take the average or max bin value as an in silico pooling
sample.info$Level = toupper(sample.info$Level)

range(mergedSegs[1,])
range(x)
plot( x )



x = (mergedSegs[1,]-mean(apply(allDf[,1:ncol(mergedSegs)], 1, mean)))/mean(apply(allDf[,1:ncol(mergedSegs)], 1, sd))
  #sd(apply(allDf[,1:ncol(mergedSegs)], 1, sd))


# names = colnames(mergedSegs)
# mergedSegs = t(apply(mergedSegs, 1, scale, center=T))
# colnames(mergedSegs) = names
# 
# names = colnames(mergedArms)
# mergedArms = t(apply(mergedArms, 1, scale, center=T))
# colnames(mergedArms) = names



samples = unique(subset(sample.info, !Level %in% c('BLD','GASTRIC'), select=c("PatientID", "EndoID"))) 

meanBinSegs = as.data.frame(matrix(ncol=ncol(mergedSegs), nrow=0, dimnames=list(c(), colnames(mergedSegs))))
meanBinArms = as.data.frame(matrix(ncol=ncol(mergedArms), nrow=0, dimnames=list(c(), colnames(mergedArms))))

mean.qcdata = data.frame(matrix(ncol=8, nrow=0, dimnames=list(c(), c('Samplename','Status','SampleType','Timepoint','mean.sca','mean.ploidy','mean.fit','mean.purity'))))

for (i in 1:nrow(samples)) {
  samples[i,]
  print(paste(samples$PatientID[i], '(',i,')'))

  #rows = subset(sample.info, PatientID == samples$PatientID[i] & EndoID == samples$EndoID[i] )$Samplename
  ptendoID = paste(samples$PatientID[i], samples$EndoID[i], sep='_')
  
  mean.qcdata[i,] = 
    cbind('Samplename'=ptendoID, subset(qcdata, SampleType == 'BE' & grepl(paste(samples$PatientID[i], samples$EndoID[i], sep='.*'), Samplename)) %>% group_by(Status, SampleType, Timepoint) %>%
    dplyr::summarise(mean.sca=mean(SCA.Ratio), mean.ploidy=mean(Ploidy), mean.fit=mean(Goodnessoffit), mean.purity=mean(Purity)))

  rows = grep(paste(samples$PatientID[i], samples$EndoID[i], sep='.*'), rownames(mergedSegs), value=T)
  
  sharedR = intersect(rows, rownames(mergedSegs))
  if (length(rows) != length(sharedR)) {
      warning(paste("Missing samples for", endo$PatientID))
      rows = sharedR
  }
  
  #meanBinSegs[ptendoID,] = apply(mergedSegs[rows,,drop=F], 2, mean)
  meanBinSegs[ptendoID,] = apply(mergedSegs[rows,,drop=F], 2, function(x) x[which.max(abs(x))] )
  #meanBinArms[ptendoID,] = apply(mergedArms[rows,,drop=F], 2, mean)
  meanBinArms[ptendoID,] = apply(mergedArms[rows,,drop=F], 2, function(x) x[which.max(abs(x))] )
} 

normalSegs = mergedSegs[grep('BLD|gastric',rownames(mergedSegs),ignore.case=T),]
normalArms = mergedArms[grep('BLD|gastric',rownames(mergedArms),ignore.case=T),]

meanBinSegs = as.matrix(meanBinSegs) 
meanBinArms = as.matrix(meanBinArms)

dim(meanBinSegs)
  
lowSeg = mergedSegs[grep('^403', rownames(mergedSegs), value=T),,drop=F]
p1 = ggplot(melt(lowSeg), aes(Var2, value)) + facet_grid(~Var1, space='free_x', scales='free') + geom_point() +
  theme(axis.text.x=element_blank() ) + labs(title='Low SCA samples', subtitle='patient 403')
lowSeg = meanBinSegs[grep('^403', rownames(meanBinSegs), value=T),,drop=F]
p2 = ggplot(melt(lowSeg), aes(Var2, value)) + facet_grid(~Var1, space='free_x', scales='free') + geom_point() +
  theme(axis.text.x=element_blank() ) + labs(title='Low SCA samples, mean bins', subtitle='patient 403')

grid.arrange(p1,p2)

highSeg = mergedSegs[grep('^512', rownames(mergedSegs), value=T),,drop=F]
p1 = ggplot(melt(highSeg), aes(Var2, value)) + facet_grid(~Var1, space='free_x', scales='free') + geom_point() +
  theme(axis.text.x=element_blank() ) + labs(title='Mixed SCA samples', subtitle='patient 512')
highSeg = meanBinSegs[grep('^512', rownames(meanBinSegs), value=T),,drop=F]
p2 = ggplot(melt(highSeg), aes(Var2, value)) + facet_grid(~Var1, space='free_x', scales='free') + geom_point() +
  theme(axis.text.x=element_blank() ) + labs(title='Mixed SCA samples, mean bins', subtitle='patient 512')

grid.arrange(p1,p2)
```

# Values in the binned segments

Blood/gastric normals have very little variance compared to all of the BE samples (no idea which is P vs NP)

```{r normals, fig.width=6, fig.height=8, eval=F}
nm = melt(normalSegs)
be = melt(mergedSegs[grep('BLD|gastric', rownames(mergedSegs), ignore.case=T, invert=T),])
beM = melt(meanBinSegs[grep('BLD|gastric', rownames(meanBinSegs), ignore.case=T, invert=T),])

lims = range(nm$value, be$value, beM$value)

grid.arrange(
  ggplot(nm, aes(Var2, value, group=Var2)) + geom_point() + labs(title='Blood/gastric') + theme(axis.text.x = element_blank()) + ylim(lims),
  ggplot(be, aes(Var2, value, group=Var2)) + geom_point() + labs(title='BE samples') + theme(axis.text.x = element_blank()) + ylim(lims),
  ggplot(beM, aes(Var2, value, group=Var2)) + geom_point() + labs(title='BE samples, mean per endo') + theme(axis.text.x = element_blank()) + ylim(lims)
)

```



## Compare the binned values to the median LRR from ASCAT

Using a random normal sample and a known BE progresser sampe

```{r rnormals, echo=F, fig.width=8, fig.height=8, eval=F}
randNormal = sample(rownames(normalSegs), 1)
pt = unlist(strsplit(randNormal, '_'))[1]
segs = subset(segments.list[[pt]], chr %in% c(1:22) & grepl(randNormal, sample))
segs$chr = factor(segs$chr, levels=c(1:22), ordered = T)


lims = range(segs$medLRR, mergedSegs[randNormal,])
grid.arrange(
  ggplot(segs) + facet_grid(~chr, space='free_x', scales='free') + ylim(lims) +
    geom_segment(aes(x=startpos, xend=endpos, y=medLRR, yend=medLRR), size=3) + 
    theme(axis.text.x=element_blank() ) + labs(title='ASCAT median LRR', subtitle=pt),
  ggplot(melt(as.matrix(mergedSegs[randNormal,])), aes(Var1, value)) + geom_point() + ylim(lims) +
    labs(title='CN Adjusted & winsorized') + theme(axis.text.x=element_blank()),
top='Random BLD or gastric normal', bottom=randNormal)

randBE = '512_18762_133R_27.LogR'
pt = unlist(strsplit(randBE, '_'))[1]
segs = subset(segments.list[[pt]], chr %in% c(1:22) & grepl(randBE, sample))
segs$chr = factor(segs$chr, levels=c(1:22), ordered = T)

lims = range(segs$medLRR, mergedSegs[sub('\\.LogR','',randBE),])
grid.arrange(
  ggplot(segs) + facet_grid(~chr, space='free_x', scales='free') + ylim(lims) +
    geom_segment(aes(x=startpos, xend=endpos, y=medLRR, yend=medLRR), size=3) + 
    theme(axis.text.x=element_blank() ) + labs(title='Median LRR, ASCAT segments', subtitle=pt), 
  ggplot(melt(as.matrix(mergedSegs[sub('\\.LogR','',randBE),])), aes(Var1, value)) + geom_point() + ylim(lims) + 
    theme(axis.text.x=element_blank()) + labs(title='Winsorized LRR, binned'),  
top='BE', bottom=randBE)


```


# Set up values to predict

## Adjust per column

Adjust the variance of each genomic region by the mean and sd extracted when I trained on the sWGS data. This seems to be a more fair comparison than scaling all the new data to itself, but the predictions don't really change.

Using the mean bin values.
```{r, warning=F}
adjust.cols<-function(mtx, means=NULL, sds=NULL) {
  if (!is.null(means)) {
    if (ncol(mtx) != length(means))
      stop("Vector of means needs to match the columns in the matrix")
    for (i in 1:ncol(mtx)) 
      mtx[,i] = unit.var(mtx[,i], means[i], sds[i])
  } else {
    for (i in 1:ncol(mtx)) 
      mtx[,i] = unit.var(mtx[,i])
  }
  return(mtx)
}

ns = adjust.cols(normalSegs, z.mean, z.sd)
na = adjust.cols(normalArms, z.arms.mean, z.arms.sd)

ms = adjust.cols(meanBinSegs, z.mean, z.sd)
ms = adjust.cols(mergedSegs, z.mean, z.sd)
range(ms)
dim(ms)

ma = adjust.cols(meanBinArms, z.arms.mean, z.arms.sd)
ma = adjust.cols(mergedArms, z.arms.mean, z.arms.sd)
range(ma)
dim(ma)

nm = melt(ns)
be = melt(ms[grep('BLD|gastric', rownames(ms), ignore.case=T, invert=T),])

grid.arrange(
  ggplot(nm, aes(Var2, value, group=Var2)) + geom_point() + labs(title='Blood/gastric') + 
    theme(axis.text.x=element_blank()) +ylim(range(nm$value, be$value)),
  ggplot(be, aes(Var2, value, group=Var2)) + geom_point() + labs(title='BE samples') + 
    theme(axis.text.x=element_blank()) + ylim(range(nm$value, be$value)), top='Unit scaled')

```

Normal variance: `r var(nm$value, na.rm=T)`

BE variance: `r var(be$value, na.rm=T)`


```{r echo=F}
cx = score.cx(ms, 1)
arrayDf = subtract.arms(ms, ma)
arrayDf = cbind(arrayDf, 'cx'=unit.var(cx, mn.cx, sd.cx))

cxN = score.cx(ns, 1)
arrayDfNorm = subtract.arms(ns, na)
arrayDfNorm = cbind(arrayDfNorm, 'cx'=unit.var(cxN, mn.cx, sd.cx))

probN = predict(fitV, newx=arrayDfNorm, s=l, type='response')
length(which(probN > 0.5))/nrow(probN) # FPR
length(which(probN <= 0.5))/nrow(probN)

#qqnorm(allDf, main='Normal Q-Q plot, sWGS')
#qqnorm(arrayDf, main='Normal Q-Q plot, SNP arrays')

```

# Predictions

```{r, warning=F, fig.height=8}
prob = predict(fitV, newx=arrayDf, s=l, type='response')
rr = predict(fitV, newx=arrayDf, s=l, type='link')

preds = cbind.data.frame(rownames(prob),prob, rr)
colnames(preds) = c('Samplename','Prob', 'RR')

#offset = log(0.0225)
# preds = preds %>% dplyr::mutate( 
#   'Adj. RR'=RR+offset,  
#   'Adj. Prob'=1/(1+exp(-RR+abs(offset)) )
# )

myPal = rev(RColorBrewer::brewer.pal(11, 'RdYlBu'))
grid.arrange(
  ggplot(preds, aes(RR)) + geom_histogram(aes(fill=..x..), bins=15, show.legend = F) +
    scale_fill_gradientn(colors = myPal,  name='') + 
    labs(y='n Samples', x='Relative Risk', title='Unadjusted relative risk'),
  # ggplot(preds, aes(`Adj. RR`)) + geom_histogram(aes(fill=..x..), bins=15, show.legend = F) +
  #   scale_fill_gradientn(colors = myPal,  name='') + 
  #   labs(y='n Samples', x='Relative Risk', title='Adjusted relative risk'), 
top='Relative risk')


grid.arrange(
  ggplot(preds, aes(Prob)) + geom_histogram(aes(fill=..x..), breaks=seq(0,1,0.1) , show.legend = F) +
    scale_fill_gradientn(colors = myPal,  name='') + 
    labs(title='Predictions, all samples model', y='n Samples', x='Unadjusted Probability'),
  # ggplot(preds, aes(`Adj. Prob`)) + geom_histogram(aes(fill=..x..), breaks=seq(0,1,0.1) , show.legend = F) +
  #   scale_fill_gradientn(colors = myPal,  name='') + 
  #   labs(title='Predictions, all samples model', y='n Samples', x='Adjusted Probability'), 
top='Probability') 

#randNormal = paste(unlist(strsplit(randNormal, '_'))[c(1,3)], collapse='_')
#randBE = paste(unlist(strsplit(randBE, '_'))[c(1,3)], collapse='_')
```

A quick look at the two random samples from earlier.  
`r pander(subset(preds, Samplename == randNormal), caption='Random normal')`

The random BE shows a very high probability:
`r pander(subset(preds, Samplename == randBE), caption='Random BE')`


## Evaluating predictions

```{r, warning=F, fig.height=8}
# normals = subset(preds, grepl('BLD|gastric', Samplename, ignore.case=T))
# grid.arrange(
#   ggplot(normals, aes(Prob)) + geom_histogram(aes(fill=..x..), breaks=seq(0,1,0.1) , show.legend = F) +
#     scale_fill_gradientn(colors = myPal,  name='') + 
#     labs(title='Predictions on BLD/Gastric', y='n Samples', x='Unadjusted Probability'),
# top='BLD/gastric normals' )
# 
# normals[which(normals$Prob > 0.5),]


pred.qc = base::merge(preds, mean.qcdata, by='Samplename')
#pred.qc = base::merge(preds, qcdata, by='Samplename')

prog = subset(pred.qc, !grepl('BLD|gastric', Samplename, ignore.case=T) & Status == 'P')
ggplot(prog, aes(Prob)) + facet_grid(~Timepoint) + 
  geom_histogram(aes(fill=..x..), breaks=seq(0,1,0.1) , show.legend = F) +
  scale_fill_gradientn(colors = myPal,  name='') + 
  labs(title='Predictions on progressors', y='n Samples', x='Unadjusted Probability')


nonprog = subset(pred.qc, !grepl('BLD|gastric', Samplename, ignore.case=T) & Status == 'NP')
ggplot(nonprog, aes(Prob)) + facet_grid(~Timepoint) + 
  geom_histogram(aes(fill=..x..), breaks=seq(0,1,0.1) , show.legend = F) +
  scale_fill_gradientn(colors = myPal,  name='') + 
  labs(title='Predictions on non-progressors', y='n Samples', x='Unadjusted Probability')

```


# Compare predictions to known status

```{r roc, echo=T}
si = do.call(rbind.data.frame,c(strsplit(as.character(pred.qc$Samplename), '_'), stringsAsFactors=F) )
if (ncol(si) == 4) {
  colnames(si) = colnames(sample.info)[1:4]
} else {
  colnames(si) = colnames(sample.info)[1:2]
}
pred.qc = cbind(si, pred.qc)
pred.qc = base::merge( pred.qc, patient.info[,c('PatientID','Pathology')], by='PatientID')

rows = grep('BLD|gastric', pred.qc$Samplename, ignore.case=T)
if (length(rows) > 0) {
  normals = pred.qc[rows,]
  pred.qc = pred.qc[-rows,]
}
nrow(pred.qc)

# Three groups, prog, non prog (max LGD), non prog (max HGD)
pred.qc = pred.qc %>% group_by(Status, PatientID) %>% dplyr::mutate( exclude=(Status == 'NP' & length(which(Pathology == 'HGD')) > 0) )
pred.qc$Status = factor(pred.qc$Status)

# Exclude those odd tetraploidy NPs
pred.qc[which(with(pred.qc, (Samplename %in% highPloidyCN$Samplename))), 'exclude'] = T
pred.qc[which(pred.qc$PatientID %in% subset(pred.qc, Samplename %in% highPloidyCN$Samplename)$PatientID), 'exclude'] = T

# Exclude HGD NP patients
pred = subset(pred.qc, !exclude)

roc = pROC::roc(Status ~ Prob, data=pred, auc=T, ci=T, of='thresholds')
roc.plot(roc)

#rocNoLow = pROC::roc(Status ~ Prob, data=subset(pred, !Samplename %in% c(lowsca$Samplename)), auc=T, ci=T, of='thresholds')
#roc.plot(rocNoLow)

per_pt = pred %>% group_by(PatientID, Timepoint, Status) %>% dplyr::summarise( max.Prob = max(Prob), max.RR = max(RR) )
rocpp = pROC::roc(Status ~ max.Prob, data=per_pt, auc=T, ci=T, of='thresholds')
roc.plot(rocpp)

per_pt_ex = subset(pred, !Samplename %in% c(lowsca$Samplename,highPloidyCN$Samplename)) %>% group_by(PatientID, Timepoint, Status) %>% dplyr::summarise(
  max.Prob = max(Prob), max.RR = max(RR)
)
rocppex = pROC::roc(Status ~ max.Prob, data=per_pt_ex, auc=T, ci=T, of='thresholds')
roc.plot(rocppex)

roct2 = pROC::roc(Status ~ Prob, data=subset(pred, Timepoint != 'T1' & !Samplename %in% c(lowsca$Samplename)), auc=T, ci=T, of='thresholds')
roc.plot(roct2)


```

# Regions predicted by model
Not evaluated currently
```{r coefs, eval=F}
features = coefs$`0.9`[,1,drop=F]

locs = do.call(rbind.data.frame, c(strsplit(rownames(features), ':|-'), stringsAsFactors=F))
colnames(locs) = c('chr','start','end')
locs[] = lapply(locs[], as.numeric)

feature.locs = makeGRangesFromDataFrame(locs)

gr = makeGRangesFromDataFrame(segments.list$`512`, start.field = 'startpos', end.field = 'endpos', keep.extra.columns = T)

ov = findOverlaps(feature.locs, gr)

feature.locs[unique(queryHits(ov))]

cna = lapply( unique(queryHits(ov)), function(hit) {
  tmp = gr[subjectHits(ov[queryHits(ov) == hit])]
  tmp = subset(as.data.frame(tmp), nMajor+nMinor > 2.3 | nMajor+nMinor < 1.5) %>% group_by(sample, nMajor+nMinor) %>% dplyr::summarise( n=length(sample), medLRR=mean(medLRR), mn.bp=mean(end-start) ) %>% rowwise() %>% 
    dplyr::mutate( type=ifelse(`nMajor + nMinor` >= 3, 1, 0))
})
names(cna) = rownames(features)

fl = sapply(cna, function(x) length(unique(x$sample)))
feature.locs[which(fl == 0)]

cna.count = do.call(rbind, lapply(cna, function(x) table(x$type)))

cna.mx = as.matrix(sapply(cna, function(x) length(unique(x$sample))))
cna.mx = cbind('sample.cnt'=cna.mx, 'loss'=NA,'gain'=NA, 'loss.bp', 'gain.bp')
for (ft in rownames(features)) {
  cna.mx[ft,c('loss','gain')] = c(0,0)
  if (nrow(cna[[ft]]) > 0)
    cna.mx[ft,c('loss','gain')] = c(length(which(cna[[ft]]$type == 0)),length(which(cna[[ft]]$type == 1)))
  
  median(cna[[ft]] [[cna[[ft]]$type == 0,'mn.bp']] )
  
  
  
}


cna$`1:59820150-64805161`


```


# Regression using SNP Data


```{r regression, echo=F, eval=F}
slabels = sample.info[,c('PatientID','Status', 'Samplename')]

missing = setdiff(sample.info$Samplename, rownames(arrayDf))
rows = grep('BLD|gastric', rownames(arrayDf), ignore.case=T)
bld_gastric = arrayDf[rows,]

df = arrayDf[-rows,]


slabels = subset(slabels, Samplename %in% rownames(df))

status = as.integer(as.factor(slabels$Status))-1
names(status) = slabels$Samplename

df = df[-grep(setdiff(rownames(df),names(status)), rownames(df)),]

#df = arrayDf[which(!rownames(arrayDf) %in% c(lowsca$Samplename,highPloidyCN$Samplename)),]

source('lib/cv-pt-glm.R')


nl = 1000;folds = 10; splits = 5 
sets = create.patient.sets(slabels, folds, splits, 0.2)  

#sets = create.patient.sets(subset(sample.info, !Samplename %in% c(lowsca$Samplename,highPloidyCN$Samplename)) [c('PatientID','Samplename','Status')], folds, splits, 0.2)  

alpha.values = c(0,0.5,0.9,1)
## ----- All ----- ##
coefs = list(); plots = list(); performance.at.1se = list(); models = list(); cvs = list()
cache.dir = '~/Data/Ellie/Analysis/SNP/'
dir.create(cache.dir, recursive = T, showWarnings = F)
file = paste(cache.dir, 'all.pt.alpha.Rdata', sep='/')
#if (file.exists(file)) {
#  message(paste("loading", file))
#  load(file, verbose=T)
#} else 
  {
  for (a in alpha.values) {
    fit0 <- glmnet(df, status, alpha=a, nlambda=nl, family='binomial', standardize=F)    
    autoplot(fit) + theme(legend.position="none")
    l = fit0$lambda

    cv.patient = crossvalidate.by.patient(x=df, y=status, lambda=l, pts=sets, a=a, nfolds=folds, splits=splits, fit=fit0, select='deviance', opt=-1, standardize=F)
    
    lambda.opt = cv.patient$lambda.1se
    
    coef.opt = as.data.frame(non.zero.coef(fit0, lambda.opt))
    coefs[[as.character(a)]] = coef.stability(coef.opt, cv.patient$non.zero.cf)
    
    plots[[as.character(a)]] = arrangeGrob(cv.patient$plot+ggtitle('Classification'), cv.patient$deviance.plot+ggtitle('Binomial Deviance'), top=paste('alpha=',a,sep=''), ncol=2)
    
    performance.at.1se[[as.character(a)]] = subset(cv.patient$lambdas, `lambda-1se`)
    models[[as.character(a)]] = fit0
    cvs[[as.character(a)]] = cv.patient
  }
  save(plots, coefs, performance.at.1se, dysplasia.df, models, cvs, labels, file=file)
  p = do.call(grid.arrange, c(plots[ as.character(alpha.values) ], top='All samples, 10fold, 5 splits'))
  ggsave(paste(cache.dir, '/', 'all_samples_cv.png',sep=''), plot = p, scale = 2, width = 12, height = 10, units = "in", dpi = 300)
}
all.coefs = coefs
save(arrayDf,labels,patient.info, file=paste(cache.dir,'snp.Rdata',sep='/'))
```