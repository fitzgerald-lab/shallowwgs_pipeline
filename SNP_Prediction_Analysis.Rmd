---
title: "SNP Analysis"
author: "Sarah Killcoyne"
date: "6/13/2018"
output: html_document
---

```{r setup, include=FALSE}
library(ggplot2)
library(gridExtra)
library(glmnet)
library(pander)
library(readxl)
library(pROC)
library(ggfortify)

suppressPackageStartupMessages(source('lib/data_func.R'))
suppressPackageStartupMessages(source('lib/common_plots.R'))


chr.info = get.chr.lengths(file='~/tmp/hg19_info.txt')

adjust.cols<-function(mtx, means=NULL, sds=NULL) {
  if (!is.null(means)) {
    if (ncol(mtx) != length(means))
      stop("Vector of means needs to match the columns in the matrix")
    for (i in 1:ncol(mtx)) 
      mtx[,i] = unit.var(mtx[,i], means[i], sds[i])
  } else {
    for (i in 1:ncol(mtx)) 
      mtx[,i] = unit.var(mtx[,i])
  }
  return(mtx)
}

load('~/Data/Ellie/Analysis/5e6_arms_all_logR/model_data.Rdata', verbose = T)
load('~/Data/Ellie/Analysis/5e6_arms_all_logR/all.pt.alpha.Rdata', verbose = T)
#alpha = '0'
alpha = '0.9'
fitV = models[[alpha]]
l = performance.at.1se[[alpha]]$lambda

swgs_labels = labels

rm(plots,performance.at.1se,models,cvs,labels)

pv = var(dysplasia.df[swgs_labels == 1])  # P
npv = var(dysplasia.df[swgs_labels == 0]) # NP

range(dysplasia.df[swgs_labels == 1])
range(dysplasia.df[swgs_labels == 0])

load('~/Data/Reid_SNP/PerPatient/allpts_ascat.Rdata', verbose=T)

patient.info = as.data.frame(read_xlsx('~/Data/Ellie/Analysis/SNP/metadata_T1T2.xlsx'))
patient.info$UniqueSampleID = paste(patient.info$PatientID, patient.info$`Timepoint Code`, sep='_')
patient.info$Path.Status = patient.info$Status
patient.info[patient.info$PatientID %in% subset(patient.info, Pathology %in% c('IMC','HGD'), select='PatientID')[,1], 'Path.Status'] = 'P'

sample.list = read_xlsx('~/Data/Ellie/Analysis/SNP/20180604_Reid_1M_SampleList.xlsx', sheet = 2)
nrow(sample.list)
colnames(sample.list)[3] = 'Total.SCA'

sample.list$SCA.Ratio = sample.list$Total.SCA/max(chr.info$genome.length)

sample.info  = do.call(rbind.data.frame, sapply(qcdata$Samplename, strsplit, '_'))
colnames(sample.info) = c('PatientID','SampleID','EndoID','Level')
sample.info[] = lapply(sample.info[], as.character)
sample.info[which(sample.info$PatientID == 524 & sample.info$Level == 524), 'Level'] = ''
sample.info$Samplename = qcdata$Samplename

message(paste(length(unique(sample.info$PatientID)), 'patients listed in metadata file'))
message(paste(nrow(qcdata), 'samples available'))

sample.info = base::merge(sample.info, patient.info[,c('PatientID','Timepoint','Timepoint Code','Status','Pathology')], by.x=c('PatientID','EndoID'), by.y=c('PatientID','Timepoint Code'))

get.ratio<-function(PID, SID) {
  subset(sample.list, PatientID == PID & SampleNum == SID)$SCA.Ratio
}

sample.info = sample.info %>% rowwise() %>% dplyr::mutate(
  SCA.Ratio = ifelse(Level %in% c('BLD','GASTRIC'), 0, get.ratio(PatientID, SampleID))
)

```

## Patient info 

`r nrow(patient.info)` total endoscopies, `r pander(table(patient.info$Status), caption="Split between P and NP")`

Histology breakdown:

```{r, echo=F}

patient.info = patient.info %>% rowwise() %>% dplyr::mutate( Endoscopy = ifelse(Timepoint == 'T1', 1, 2) )

sm = patient.info %>% group_by(Status, Endoscopy, Pathology) %>% dplyr::tally() %>% group_by(Status, Endoscopy) %>% dplyr::mutate(freq=n/sum(n) )
sm$Pathology = factor(sm$Pathology, levels=c('NDBE','ID','LGD','HGD','IMC'), ordered = T)

ggplot(sm, aes(Pathology, freq, group=Endoscopy, fill=factor(Endoscopy))) + facet_grid(~Status) + 
  geom_col(position = position_dodge()) + ylim(0,1) + labs(title='Pathology frequency per timepoint')
```


There's a significant difference in the numbers of NDBE or HGD samples between the groups
```{r, echo=F}
pander(chisq.test(table(patient.info$Pathology, patient.info$Status)['HGD',]), caption='HGD')
pander(chisq.test(table(patient.info$Pathology, patient.info$Status)['NDBE',]), caption='NDBE')

# Most progressors are HGD at timepoint 1
pander( round(with(subset(patient.info, Endoscopy == 1), table(Pathology, Status))['HGD',]/table(subset(patient.info, Endoscopy == 1)$Status), 3)*100, caption='% at T1')
```

# Quick QC 
In the sWGS data progressor samples show a variance of `r round(pv, 3)` and non-prog variance is `r round(npv,3)`

Purity, ploidy and goodnessoffit from single sample (not paired) ASCAT.

```{r, echo=F, warning=F, message=F}
qcdata$SampleType = 'BE'
qcdata$SampleType[grep('BLD',rownames(qcdata), ignore.case=T)] = 'Blood Normal'
qcdata$SampleType[grep('gastric',rownames(qcdata), ignore.case=T)] = 'Gastric Normal'
head(qcdata)

qcdata = base::merge(qcdata, sample.info[,c('Samplename','Status','Timepoint','SCA.Ratio')], by='Samplename')

ggplot(qcdata, aes(round(Ploidy,2))) + geom_histogram() + 
  facet_wrap(~SampleType, scales='free_y', ncol=1) + labs(x='Ploidy', title='Ploidy, normal vs BE')

ggplot(qcdata, aes(Purity, Goodnessoffit, color=Status)) + geom_point() + facet_wrap(~SampleType, ncol=1) + 
  labs(title='Purity~fit, normal vs BE')

ggplot(qcdata, aes(SCA.Ratio)) + geom_histogram() + 
  facet_wrap(~Status, scales='free_y', ncol=1) + labs(x='SCA Ratio', title='SCA Ratio, NP vs P')

ggplot(subset(qcdata, SampleType == 'BE'), aes(Purity, SCA.Ratio, color=Status)) + geom_point() + 
  geom_vline(xintercept = 0.95, color='red') + geom_hline(yintercept = 0.05, color='red') + 
  labs(title='Barretts only')

ggplot(subset(qcdata, SampleType == 'BE'), aes(Ploidy, SCA.Ratio, color=Status)) + geom_point() + 
  geom_hline(yintercept = 0.05, color='red') + labs(title='Barretts only')

## PER ENDOSCOPY
qcdata.samples = qcdata %>% group_by(Samplename) %>% dplyr::mutate(
  PatientID = unlist(strsplit(Samplename, '_'))[1],
  EndoID = unlist(strsplit(Samplename, '_'))[3],
  Level = unlist(strsplit(Samplename, '_'))[4] 
) 

qcdata = qcdata.samples %>% group_by(PatientID, EndoID, Status, Timepoint, SampleType) %>% dplyr::summarise(
  Ploidy = mean(Ploidy), Purity = mean(Purity), Goodnessoffit = mean(Goodnessoffit), SCA.Ratio = mean(SCA.Ratio)
)

## Low CN
lowPloidyCN = subset(qcdata, Status == 'P' & SampleType == 'BE' & SCA.Ratio <= 0.05 & Ploidy <= 2)

## samples have no apparent CN
noCN = subset(qcdata, Status == 'P' & SCA.Ratio <= 0 & SampleType == 'BE')

## high CN | ploidy, nonP
highPloidyCN = subset(qcdata, Status == 'NP' & SampleType == 'BE' & (SCA.Ratio >= mean(qcdata$SCA.Ratio,na.rm=T)+ sd(qcdata$SCA.Ratio,na.rm=T)*2 | Ploidy >= 2.3))

```

#### P: Low SCA, Ploidy<=2
`r round(nrow(lowPloidyCN)/nrow(subset(qcdata, Status == 'P' & SampleType == 'BE')), 3)*100`% of PROGRESSOR endoscopies have <5% SCA and an ASCAT ploidy of 2 or less. Most of these show a >90% purity as well.
`r pander(summary(lowPloidyCN$Purity))`

#### P: No SCA
`r round(nrow(noCN)/nrow(subset(qcdata, Status == 'P' & SampleType == 'BE')), 3)*100`% of PROGRESSOR endoscopies have 0 SCA

#### NP: High CN or ploidy > 2.3
`r round(nrow(highPloidyCN)/nrow(subset(qcdata, Status == 'NP' & SampleType == 'BE')), 3)*100`% of NON-PROGRESSOR samples have >2SD SCA (~25%) or high ploidy.


```{r, echo=F, warning=F, fig.height=10, fig.width=8,eval=F}

qcdata$SCA.Ratio = round(qcdata$SCA.Ratio, 4)

lowsca = subset(qcdata, Status == 'P' & SampleType == 'BE' & SCA.Ratio <= 0.05 & Ploidy <= 2)


summary.file = '~/Data/Annalise/NonP/summary_logR.txt'
smy = read.table(summary.file, sep = '\t', header = T)
smy = subset(smy, Copy.number <= 12)

a = as.data.frame(smy[,c('Copy.number','var.LRR')])
colnames(a) = c('x','y')
b = as.data.frame(smy[,c('Copy.number','median.LRR')])
colnames(b) = c('x','y')
b[b$x == 2,'y'] = 0

fitSD = lm(x~y, data=a)
autoplot(fitSD)
fitM = lm(x~y, data=b)
autoplot(fitM)

fitCN = lm(y~x, data=b)

# Adjust based on the summary values per CN that we get in WGS (mostly) NP Barrett's cases
adjust.segraw<-function(segraw) {
  segraw = segraw %>% rowwise() %>% dplyr::mutate( total = nAraw+nBraw )
  segraw = subset(segraw, chr %in% c(1:22))

  segraw$adjLRR = NA
  #for (cn in unique(segraw$total)) {
  #  rows = which(segraw$total == cn)
  #  values = seg[rows, 'medLRR', drop=T]
    
    #newM = mean(values)
    #newSD = sd(values)
    
    #if (cn != 2) {
      #newM = predict(fitM, newdata=cbind.data.frame('x'=cn))
      #newSD = predict(fitSD, newdata=cbind.data.frame('x'=cn))
      
    #newV = mean(values)
      
    #}
    #segraw[rows,][['adjLRR']] = newM + (values - mean(values)) * (newSD/sd(values))
   # smy
    #median(predict(fitM, newdata=cbind.data.frame('y'=values)))-cn
    
    
    new = predict(fitCN, newdata=cbind.data.frame('x'=segraw$total))
    #plot(scale(new, center = T))
    
    segraw[,'adjLRR'] = scale(new,center=T)
    
   # segraw[rows,'adjLRR'] = (values * (predict(fitM, newdata=cbind.data.frame('y'=values)) - cn))
  #}  
segraw  
}


pt = '403'
pfiles = list.files(paste('~/Data/Reid_SNP/PerPatient', pt, sep='/'), full.names = T)
load(grep('ascat.Rdata', pfiles, value=T), verbose=F)

seg = ascat.output$segments_raw
seg = adjust.segraw(seg)

m = (melt(seg, measure.vars=c('medLRR','adjLRR')))
m$total = round(round(m$total, 1))
ggplot(m, aes(total, value, group=total)) + facet_grid(~variable) + geom_boxplot() + labs(title=pt)


seg$chr = factor(seg$chr, levels=c(1:22))
grid.arrange(
  ggplot(seg) + facet_grid(sample~chr, space='free_x', scales='free_x') +
    geom_segment(aes(x=startpos, xend=endpos, y=medLRR, yend=medLRR), color='darkgreen', size=3) + 
    theme(axis.text.x=element_blank() ) + labs(title='Low SCA, medLRR', subtitle=paste('patient',pt)),
  ggplot(seg) + facet_grid(sample~chr, space='free_x', scales='free_x') + 
    geom_segment(aes(x=startpos, xend=endpos, y=adjLRR, yend=adjLRR), color='darkred', size=3) + 
    theme(axis.text.x=element_blank() ) + labs(title='Low SCA, adjLRR', subtitle=paste('patient',pt))
)



pt = '512'
pfiles = list.files(paste('~/Data/Reid_SNP/PerPatient', pt, sep='/'), full.names = T)
load(grep('ascat.Rdata', pfiles, value=T), verbose=F)

seg = ascat.output$segments_raw
seg = adjust.segraw(seg)

m = (melt(seg, measure.vars=c('medLRR','adjLRR')))
m$total = round(round(m$total, 1))
ggplot(m, aes(total, value, group=total)) + facet_grid(~variable) + geom_boxplot() + labs(title=pt)


seg$chr = factor(seg$chr, levels=c(1:22))
grid.arrange(
  ggplot(seg) + facet_grid(sample~chr, space='free_x', scales='free_x') + 
    geom_segment(aes(x=startpos, xend=endpos, y=medLRR, yend=medLRR), color='darkgreen', size=3) + 
    theme(axis.text.x=element_blank() ) + labs(title='Mixed SCA, medLRR', subtitle=paste('patient',pt)),
  ggplot(seg) + facet_grid(sample~chr, space='free_x', scales='free_x') + 
    geom_segment(aes(x=startpos, xend=endpos, y=adjLRR, yend=adjLRR), color='darkred', size=3) + 
    theme(axis.text.x=element_blank() ) + labs(title='Mixed SCA, adjLRR', subtitle=paste('patient',pt))
)




```


# Load tiled data

CN Adjustment uses Annalise's whole-genome non-progressor samples to generate a set of mean and SD values per copy-number state. The median LogR values are adjusted using the mean and SD based on the CN state.  The adjusted LogR values are then winsorize per sample, and tiled in 5Mb bins.

```{r, warning=F, echo=F, message=F, fig.height=10, fig.width=8}

if (file.exists('~/Data/Reid_SNP/PerPatient/tmp_seg_pt.Rdata')) {
  load('~/Data/Reid_SNP/PerPatient/tmp_seg_pt.Rdata', verbose=T) 
} else {

mergedSegs = NULL
mergedArms = NULL
length(ptdirs)

for (pt in ptdirs) {
  print(pt)
  if (length(list.files(pt, '*wins_tiled.txt', full.names=T)) <= 0) {
    message(paste("No tiled files for",pt))
    next
  }

  segvals = as.data.frame(data.table::fread(list.files(pt, '*wins_tiled.txt', full.names=T)))
  armvals = as.data.frame(data.table::fread(list.files(pt, '*arms_tiled.txt', full.names=T)))
  
  segvals = segment.matrix(segvals)
  segvals[is.na(segvals)] = mean(segvals,na.rm=T)
  
  armvals = segment.matrix(armvals)
  armvals[is.na(armvals)] = mean(armvals,na.rm=T)

  if (is.null(segvals) | is.null(armvals))
    stop(paste("Missing values in ", pt))
  
  if (is.null(mergedSegs)) {
    mergedSegs = segvals
    mergedArms = armvals
  } else {
    mergedSegs = rbind(mergedSegs, segvals)    
    mergedArms = rbind(mergedArms, armvals)    
  }
}
nrow(mergedSegs) == nrow(mergedArms)
#setdiff(rownames(mergedSegs), rownames(mergedArms))
dim(mergedSegs)

save(mergedSegs, mergedArms, file='tmp_seg_pt.Rdata')
}
rownames(mergedSegs) = sub('\\.LogR','', rownames(mergedSegs))
rownames(mergedArms) = sub('\\.LogR','', rownames(mergedArms))

dim(mergedSegs)
dim(mergedArms)

nm.rows = grep('BLD|GASTRIC', rownames(mergedSegs))
normalSegs = mergedSegs[nm.rows,]
normalArms = mergedArms[nm.rows,]

nrow(normalSegs) == nrow(normalArms)

mergedSegs = mergedSegs[-nm.rows,]
mergedArms = mergedArms[-nm.rows,]

nrow(mergedSegs) == nrow(mergedArms)

lowSeg = mergedSegs[grep('^403', rownames(mergedSegs), value=T),,drop=F]
p1 = ggplot(melt(lowSeg), aes(Var2, value)) + facet_grid(~Var1, space='free_x', scales='free') + geom_point() +
  theme(axis.text.x=element_blank() ) + labs(title='Low SCA samples', subtitle='patient 403')

highSeg = mergedSegs[grep('^512', rownames(mergedSegs), value=T),,drop=F]
p2 = ggplot(melt(highSeg), aes(Var2, value)) + facet_grid(~Var1, space='free_x', scales='free') + geom_point() +
  theme(axis.text.x=element_blank() ) + labs(title='Mixed SCA samples', subtitle='patient 512')

grid.arrange(p1,p2)
```

# Values in the binned segments

Blood/gastric normals have very little variance compared to all of the BE samples (no idea which is P vs NP)

```{r normals, message=F, fig.height=10, fig.width=8}
nm = melt(normalSegs)
be = melt(mergedSegs[-nm.rows,])

lims = range(nm$value, be$value)

grid.arrange(
  ggplot(nm, aes(Var2, value, group=Var2)) + geom_point() + labs(title='Blood/gastric',subtitle=paste('variance=',var(nm$value),sep=''),x='') + 
    theme(axis.text.x = element_blank()) + ylim(lims),
  ggplot(be, aes(Var2, value, group=Var2)) + geom_point() + labs(title='BE samples',subtitle=paste('variance=',var(be$value),sep=''),x='') + 
    theme(axis.text.x = element_blank()) + ylim(lims)
)

```



## Compare the binned values to the median LRR from ASCAT

Using a random normal sample and a known BE progresser sample

```{r rnormals, echo=F, warning=F, message=F, fig.width=10, fig.height=8, eval=F}
randNormal = sample(rownames(normalSegs), 1)
pt = unlist(strsplit(randNormal, '_'))[1]
segs = subset(segments.list[[pt]], chr %in% c(1:22) & grepl(sub('_', '.*', randNormal),sample))
segs$chr = factor(segs$chr, levels=c(1:22), ordered = T)

lims = range(segs$medLRR, normalSegs[randNormal,])
grid.arrange(
  ggplot(segs) + facet_grid(~chr, space='free_x', scales='free') + ylim(lims) +
    geom_segment(aes(x=startpos, xend=endpos, y=medLRR, yend=medLRR), size=3) + 
    theme(axis.text.x=element_blank() ) + labs(title='ASCAT median LRR', subtitle=pt),
  ggplot(melt(as.matrix(normalSegs[randNormal,])), aes(Var1, value)) + geom_point() + ylim(lims) +
    labs(title='CN Adjusted & winsorized') + theme(axis.text.x=element_blank()),
top='Random BLD or gastric normal', bottom=randNormal)

#randBE = '512_133R'
randBE = '1006_190V'
pt = unlist(strsplit(randBE, '_'))[1]
segs = subset(segments.list[[pt]], chr %in% c(1:22) & grepl(sub('_', '.*',randBE), sample))
segs$chr = factor(segs$chr, levels=c(1:22), ordered = T)

lims = range(segs$medLRR, mergedSegs[sub('\\.LogR','',randBE),])
grid.arrange(
  ggplot(segs) + facet_grid(~chr, space='free_x', scales='free')  +
    geom_segment(aes(x=startpos, xend=endpos, y=medLRR, yend=medLRR), size=3) + 
    theme(axis.text.x=element_blank() ) + labs(title='Median LRR, ASCAT segments', subtitle=pt), 
  ggplot(melt(as.matrix(mergedSegs[sub('\\.LogR','',randBE),])), aes(Var1, value)) + geom_point() +
    theme(axis.text.x=element_blank()) + labs(title='Winsorized LRR, binned'),  
  ggplot(melt(adjust.cols(mergedSegs[sub('\\.LogR','',randBE),,drop=F], z.mean, z.sd)), aes(Var2, value)) + geom_point() +
    theme(axis.text.x=element_blank()) + labs(title='Col adjusted LRR, binned'),  
top='BE', bottom=randBE)

```


# Set up values to predict

## Adjust per column

Adjust the variance of each genomic region by the mean and sd extracted when I trained on the sWGS data. This seems to be a more fair comparison than scaling all the new data to itself, but the predictions don't really change.

Using the mean bin values (merged during tiling).
```{r, warning=F, message=F, fig.width=10, fig.height=8}
# z.mean[is.na(z.mean)] = median(z.mean,na.rm=T)
# z.arms.mean[is.na(z.arms.mean)] = median(z.arms.mean,na.rm=T)
# 
# z.sd[is.na(z.sd)] = median(z.sd,na.rm=T)
# z.arms.sd[is.na(z.arms.sd)] = median(z.arms.sd,na.rm=T)


ns = adjust.cols(normalSegs, z.mean, z.sd)
#ns = apply(normalSegs, 2, unit.var)
range(ns)

na = adjust.cols(normalArms, z.arms.mean, z.arms.sd)
#na = apply(normalArms, 2, unit.var)
range(na)

ms = adjust.cols(mergedSegs, z.mean, z.sd)
#ms = apply(mergedSegs, 2, unit.var)
range(ms)
dim(ms)

ma = adjust.cols(mergedArms, z.arms.mean, z.arms.sd)
#ma = apply(mergedArms, 2, unit.var)
range(ma)
dim(ma)

nm = melt(ns)
be = melt(ms)

grid.arrange(
  ggplot(nm, aes(Var2, value, group=Var2)) + geom_point() + labs(title='Blood/gastric') + 
    theme(axis.text.x=element_blank()) +ylim(range(nm$value, be$value)),
  ggplot(be, aes(Var2, value, group=Var2)) + geom_point() + labs(title='BE samples') + 
    theme(axis.text.x=element_blank()) + ylim(range(nm$value, be$value)), top='Unit scaled')

grid.arrange(
  ggplot(melt(ms[sub('\\.LogR','',randBE),,drop=F]), aes(Var2, value)) + geom_point() +
    theme(axis.text.x=element_blank()) + labs(title='Col adjusted LRR, binned'),  
  ggplot(melt(subtract.arms(ms[sub('\\.LogR','',randBE),,drop=F],ma[sub('\\.LogR','',randBE),,drop=F])), aes(Var2, value)) +
    geom_point() + theme(axis.text.x=element_blank()) + labs(title='Arms subtracted col adjusted LRR, binned'),  
  top=randBE)

  
```


```{r echo=F,message=F, fig.width=10, fig.height=8}
cxN = score.cx(ns, 1)
arrayDfNorm = subtract.arms(ns, na)
#arrayDfNorm = cbind(ns, na)
arrayDfNorm = cbind(arrayDfNorm, 'cx'=unit.var(cxN, mn.cx, sd.cx))

probN = predict(fitV, newx=arrayDfNorm, s=l, type='response')
length(which(probN > 0.5))/nrow(probN) # FPR
length(which(probN <= 0.5))/nrow(probN)

preds.normal = cbind.data.frame(rownames(probN),probN, predict(fitV, newx=arrayDfNorm, s=l, type='link'))
colnames(preds.normal) = c('Samplename','Prob', 'RR')


cx = score.cx(ms, 1)
#arrayDf = cbind(ms,ma)
arrayDf = subtract.arms(ms, ma)

arrayDf[,589:ncol(arrayDf)] = arrayDf[,589:ncol(arrayDf)]+abs(mean(arrayDf[,589:ncol(arrayDf)]))

arrayDf = cbind(arrayDf, 'cx'=unit.var(cx, mn.cx, sd.cx))

grid.arrange(
  ggplot(melt(arrayDf), aes(Var2, value)) + geom_point() + 
    geom_point(data=melt(arrayDf[,589:634]), col='red') + labs(title='SNP'),
  ggplot(melt(allDf), aes(Var2, value)) + geom_point() +
      geom_point(data=melt(allDf[,589:634]), col='red') + labs(title='sWGS'),
nrow=1)


prob = predict(fitV, newx=arrayDf, s=l, type='response')
rr = predict(fitV, newx=arrayDf, s=l, type='link')

preds = cbind.data.frame(rownames(prob),prob, rr, stringsAsFactors=F)
colnames(preds) = c('Samplename','Prob', 'RR')

grid.arrange(
  ggplot( melt(allDf), aes(sample=value)) + stat_qq() + labs(title='Normal Q-Q plot, sWGS'),
  ggplot( melt(arrayDf), aes(sample=value)) + stat_qq() + labs(title='Normal Q-Q plot, SNP arrays'),
  ncol=1
)

```

```{r, eval=F}
x = apply(mergedSegs, 1, function(x) {
  ds = c()
  for (i in 1:(length(x)-1)) {
    ds = c(ds, abs(x[[i]]) - abs(x[[i+1]]))
  }
  abs(diff(range(ds)))
})
plot(x, col=pred.qc$Status)

x1 = apply(ms, 1, function(x) {
  ds = c()
  for (i in 1:(length(x)-1)) {
    ds = c(ds, abs(x[[i]]) - abs(x[[i+1]]))
  }
  abs(diff(range(ds)))
})
plot(x1, col=pred.qc$Status)


y = apply(normalSegs, 1, function(x) {
  ds = c()
  for (i in 1:(length(x)-1)) {
    ds = c(ds, abs(x[[i]]) - abs(x[[i+1]]))
  }
  abs(diff(range(ds)))
})
plot(y)

range(y)
range(x)

nprgs = subset(pred.qc, Status == 'NP')
prgs = subset(pred.qc, Status == 'P')

t.test(x[prgs$Samplename],x[nprgs$Samplename]) 
t.test(x[prgs$Samplename],y)
t.test(x[nprgs$Samplename],y)
```

# Predictions

```{r, warning=F, fig.height=8}
#offset = log(0.0225)
# preds = preds %>% dplyr::mutate( 
#   'Adj. RR'=RR+offset,  
#   'Adj. Prob'=1/(1+exp(-RR+abs(offset)) )
# )

myPal = rev(RColorBrewer::brewer.pal(11, 'RdYlBu'))
grid.arrange(
  ggplot(preds, aes(RR)) + geom_histogram(aes(fill=..x..), bins=15, show.legend = F) +
    scale_fill_gradientn(colors = myPal,  name='') + 
    labs(y='n Samples', x='Relative Risk', title='Unadjusted relative risk'),
  # ggplot(preds, aes(`Adj. RR`)) + geom_histogram(aes(fill=..x..), bins=15, show.legend = F) +
  #   scale_fill_gradientn(colors = myPal,  name='') + 
  #   labs(y='n Samples', x='Relative Risk', title='Adjusted relative risk'), 
top='Relative risk')


grid.arrange(
  ggplot(preds, aes(Prob)) + geom_histogram(aes(fill=..x..), breaks=seq(0,1,0.1) , show.legend = F) +
    scale_fill_gradientn(colors = myPal,  name='') + 
    labs(title='Predictions, all samples model', y='n Samples', x='Unadjusted Probability'),
  # ggplot(preds, aes(`Adj. Prob`)) + geom_histogram(aes(fill=..x..), breaks=seq(0,1,0.1) , show.legend = F) +
  #   scale_fill_gradientn(colors = myPal,  name='') + 
  #   labs(title='Predictions, all samples model', y='n Samples', x='Adjusted Probability'),
top='Probability') 

#randNormal = paste(unlist(strsplit(randNormal, '_'))[c(1,3)], collapse='_')
#randBE = paste(unlist(strsplit(randBE, '_'))[c(1,3)], collapse='_')
```

A quick look at the two random samples from earlier.  
`r pander(subset(preds.normal, Samplename == randNormal), caption='Random normal')`

The random BE should show a very high probability, but for some reason is missed entirely:
`r pander(subset(preds, Samplename == randBE), caption='Random BE')`


## Evaluating predictions

```{r, warning=F, fig.height=8}
ggplot(preds.normal, aes(Prob)) + geom_histogram(aes(fill=..x..), breaks=seq(0,1,0.1) , show.legend = F) +
  scale_fill_gradientn(colors = myPal,  name='') +
  labs(title='Predictions on BLD/Gastric', y='n Samples', x='Unadjusted Probability')

length(which(preds.normal$Prob > 0.5))/nrow(preds.normal)


qcdata.be = subset(qcdata, SampleType == 'BE')

get.qcinfo<-function(vec) {
  endo = vec[2]
  pt = vec[1]
  y = subset(qcdata.be, PatientID == pt & EndoID == endo)
  y = y %>% group_by(Status, Timepoint) %>%  dplyr::summarise( mean(Ploidy), mean(Purity), mean(Goodnessoffit), mean(SCA.Ratio) )
  cbind.data.frame('PatientID'=pt, 'EndoID'=endo, y, stringsAsFactors = F)
}

qc = do.call(rbind.data.frame, c( lapply(preds$Samplename, function(x) get.qcinfo( unlist(strsplit(x, '_'))) ), stringsAsFactors=F))

pred.qc = cbind.data.frame(preds, qc)
#dim(pred.qc)
#table(pred.qc$Status)

ggplot(pred.qc, aes(`mean(SCA.Ratio)`, Prob, color=Status)) + geom_point()
ggplot(pred.qc, aes(`mean(Ploidy)`, Prob, color=Status)) + geom_point()

pander(cor.test(pred.qc$`mean(SCA.Ratio)`, pred.qc$Prob))


prog = subset(pred.qc, Status == 'P')
ggplot(prog, aes(Prob)) + facet_grid(~Timepoint) + 
  geom_histogram(aes(fill=..x..), breaks=seq(0,1,0.1) , show.legend = F) +
  scale_fill_gradientn(colors = myPal,  name='') + 
  labs(title='Predictions on progressors', y='n Samples', x='Unadjusted Probability')


nonprog = subset(pred.qc, Status == 'NP')
ggplot(nonprog, aes(Prob)) + facet_grid(~Timepoint) + 
  geom_histogram(aes(fill=..x..), breaks=seq(0,1,0.1) , show.legend = F) +
  scale_fill_gradientn(colors = myPal,  name='') + 
  labs(title='Predictions on non-progressors', y='n Samples', x='Unadjusted Probability')

```


# Compare predictions to known status

Using my thresholds

```{r roc, echo=T}
pred.qc = base::merge( pred.qc, patient.info[,c('PatientID', 'Timepoint Code','Pathology')], by.x=c('PatientID', 'EndoID'), by.y=c('PatientID','Timepoint Code') )

# Three groups, prog, non prog (max LGD), non prog (max HGD)
pred.qc = pred.qc %>% group_by(Status, PatientID) %>% dplyr::mutate( 
  exclude=(Status == 'NP' & length(which(Pathology == 'HGD')) > 0) )
pred.qc$Status = factor(pred.qc$Status)


pred.qc.ex = subset(pred.qc, !exclude)
cuts = seq(0,1,0.1)

pred.qc.ex$quants = with(pred.qc.ex, cut(Prob, breaks=cuts))
qt = as.data.frame.matrix(table(pred.qc.ex$quants, pred.qc.ex$Status))
qt$quant = rownames(qt)
pander(qt)

get.risk<-function(prob) {
  if (prob < 0.3) return('Low')
  if (prob >= 0.3 & prob < 0.7) return('Moderate')
  if (prob >= 0.7) return('High')
}

# All data
pred.qc = pred.qc %>% dplyr::rowwise() %>% dplyr::mutate(
  Risk = get.risk(Prob)
)
pred.qc$Risk = factor(pred.qc$Risk, levels=c('Low','Moderate','High'), ordered = T)


roc = pROC::roc(Status ~ Prob, data=pred.qc, auc=T, ci=T, of='thresholds')
roc.plot(roc) + labs(title='All, Prob')
pander(pROC::coords(roc, 'best'), caption='All samples, ROC best')


roc = pROC::roc(Status ~ Risk, data=pred.qc, auc=T, ci=T, of='thresholds')
roc.plot(roc) + labs(title='All, Risk')


# Exclude those odd tetraploidy NPs
#pred.qc[which(with(pred.qc, (Samplename %in% highPloidyCN$Samplename))), 'exclude'] = T
pred.qc[which(pred.qc$PatientID %in% highPloidyCN$PatientID & pred.qc$EndoID %in% highPloidyCN$EndoID), 'exclude'] = T

# Exclude HGD NP patients
roc = pROC::roc(Status ~ Prob, data=subset(pred.qc, !exclude), auc=T, ci=T, of='thresholds')
roc.plot(roc) + labs(title='Excluded low sca/NP tetra), Prob')

roc = pROC::roc(Status ~ Risk, data=subset(pred.qc, !exclude), auc=T, ci=T, of='thresholds')
roc.plot(roc) + labs(title='Excluded low sca/NP tetra), Risk')


per_pt = 
  subset(pred.qc, !exclude) %>% group_by(PatientID, Status) %>% dplyr::summarise( max.Prob = max(Prob), max.RR = max(RR), max.Risk = max(Risk) )
rocpp = pROC::roc(Status ~ max.Prob, data=per_pt, auc=T, ci=T, of='thresholds')
roc.plot(rocpp) + labs(title='Max per patient (excluded low sca/NP tetra), Prob')

rocpp = pROC::roc(Status ~ max.Risk, data=per_pt, auc=T, ci=T, of='thresholds')
roc.plot(rocpp) + labs(title='Max per patient (excluded low sca/NP tetra), Risk')


# Exclude the low SCA patients
pred.qc[which(pred.qc$PatientID %in% lowsca$PatientID & pred.qc$EndoID %in% lowsca$EndoID), 'exclude'] = T

per_pt_ex = subset(pred.qc, !exclude) %>% group_by(PatientID, Timepoint, Status) %>% dplyr::summarise(
  max.Prob = max(Prob), max.RR = max(RR), max.Risk = max(Risk)
)
rocppex = pROC::roc(Status ~ max.Prob, data=per_pt_ex, auc=T, ci=T, of='thresholds')
roc.plot(rocppex) + labs(title='Max per patient, Prob')

rocppex = pROC::roc(Status ~ max.Risk, data=per_pt_ex, auc=T, ci=T, of='thresholds')
roc.plot(rocppex) + labs(title='Max per patient, Risk')


roct2 = pROC::roc(Status ~ Prob, data=subset(pred.qc, Timepoint != 'T1' & !exclude), auc=T, ci=T, of='thresholds')
roc.plot(roct2) + labs(title='T2, Prob')

roct2 = pROC::roc(Status ~ Risk, data=subset(pred.qc, Timepoint != 'T1' & !exclude), auc=T, ci=T, of='thresholds')
roc.plot(roct2) + labs(title='T2, Risk')


ggplot(subset(pred.qc, !exclude), aes(`mean(SCA.Ratio)`,Prob, color=Risk, shape=Status)) + 
  facet_grid(~Status) + geom_point()

ggplot(subset(pred.qc, !exclude), aes(`mean(Purity)`,Prob, color=Risk, shape=Status)) + 
  facet_grid(~Status) + geom_point()

ex.pred = subset(pred.qc, !exclude)

# Quick check
nrow(subset(ex.pred, Risk == 'High' & Status == 'P'))/table(ex.pred$Status)['P']
nrow(subset(ex.pred, Risk == 'Low' & Status == 'P'))/table(ex.pred$Status)['P'] #False negatives

ggplot(melt(arrayDf), aes(Var2, value)) + geom_point() + 
  geom_point(data=melt(arrayDf['1006_190V',,drop=F]), color='red') + 
  geom_point(data=melt(arrayDf['1044_39Z',,drop=F]), color='blue')

ggplot(melt(dysplasia.df), aes(Var2, value)) + geom_point() 

grid.arrange(
  ggplot(melt(dysplasia.df[,589:ncol(dysplasia.df)]), aes(Var2, value)) + geom_point(),
  ggplot(melt(arrayDf[,589:ncol(arrayDf)]), aes(Var2, value)) + geom_point())
  

nrow(subset(ex.pred, Risk == 'Low' & Status == 'NP'))/table(ex.pred$Status)['NP']
nrow(subset(ex.pred, Risk == 'High' & Status == 'NP'))/table(ex.pred$Status)['NP'] # False positive


```

# Regions predicted by model
Not evaluated currently
```{r coefs, eval=F}
features = coefs$`0.9`[,1,drop=F]

locs = do.call(rbind.data.frame, c(strsplit(rownames(features), ':|-'), stringsAsFactors=F))
colnames(locs) = c('chr','start','end')
locs[] = lapply(locs[], as.numeric)

feature.locs = makeGRangesFromDataFrame(locs)

gr = makeGRangesFromDataFrame(segments.list$`512`, start.field = 'startpos', end.field = 'endpos', keep.extra.columns = T)

ov = findOverlaps(feature.locs, gr)

feature.locs[unique(queryHits(ov))]

cna = lapply( unique(queryHits(ov)), function(hit) {
  tmp = gr[subjectHits(ov[queryHits(ov) == hit])]
  tmp = subset(as.data.frame(tmp), nMajor+nMinor > 2.3 | nMajor+nMinor < 1.5) %>% group_by(sample, nMajor+nMinor) %>% dplyr::summarise( n=length(sample), medLRR=mean(medLRR), mn.bp=mean(end-start) ) %>% rowwise() %>% 
    dplyr::mutate( type=ifelse(`nMajor + nMinor` >= 3, 1, 0))
})
names(cna) = rownames(features)

fl = sapply(cna, function(x) length(unique(x$sample)))
feature.locs[which(fl == 0)]

cna.count = do.call(rbind, lapply(cna, function(x) table(x$type)))

cna.mx = as.matrix(sapply(cna, function(x) length(unique(x$sample))))
cna.mx = cbind('sample.cnt'=cna.mx, 'loss'=NA,'gain'=NA, 'loss.bp', 'gain.bp')
for (ft in rownames(features)) {
  cna.mx[ft,c('loss','gain')] = c(0,0)
  if (nrow(cna[[ft]]) > 0)
    cna.mx[ft,c('loss','gain')] = c(length(which(cna[[ft]]$type == 0)),length(which(cna[[ft]]$type == 1)))
  
  median(cna[[ft]] [[cna[[ft]]$type == 0,'mn.bp']] )
  
  
  
}


cna$`1:59820150-64805161`


```


# Regression using SNP Data


```{r regression, echo=F, eval=F}
slabels = sample.info[,c('PatientID','Status', 'Samplename')]

missing = setdiff(sample.info$Samplename, rownames(arrayDf))
rows = grep('BLD|gastric', rownames(arrayDf), ignore.case=T)
bld_gastric = arrayDf[rows,]

df = arrayDf[-rows,]


slabels = subset(slabels, Samplename %in% rownames(df))

status = as.integer(as.factor(slabels$Status))-1
names(status) = slabels$Samplename

df = df[-grep(setdiff(rownames(df),names(status)), rownames(df)),]

#df = arrayDf[which(!rownames(arrayDf) %in% c(lowsca$Samplename,highPloidyCN$Samplename)),]

source('lib/cv-pt-glm.R')


nl = 1000;folds = 10; splits = 5 
sets = create.patient.sets(slabels, folds, splits, 0.2)  

#sets = create.patient.sets(subset(sample.info, !Samplename %in% c(lowsca$Samplename,highPloidyCN$Samplename)) [c('PatientID','Samplename','Status')], folds, splits, 0.2)  

alpha.values = c(0,0.5,0.9,1)
## ----- All ----- ##
coefs = list(); plots = list(); performance.at.1se = list(); models = list(); cvs = list()
cache.dir = '~/Data/Ellie/Analysis/SNP/'
dir.create(cache.dir, recursive = T, showWarnings = F)
file = paste(cache.dir, 'all.pt.alpha.Rdata', sep='/')
#if (file.exists(file)) {
#  message(paste("loading", file))
#  load(file, verbose=T)
#} else 
  {
  for (a in alpha.values) {
    fit0 <- glmnet(df, status, alpha=a, nlambda=nl, family='binomial', standardize=F)    
    autoplot(fit) + theme(legend.position="none")
    l = fit0$lambda

    cv.patient = crossvalidate.by.patient(x=df, y=status, lambda=l, pts=sets, a=a, nfolds=folds, splits=splits, fit=fit0, select='deviance', opt=-1, standardize=F)
    
    lambda.opt = cv.patient$lambda.1se
    
    coef.opt = as.data.frame(non.zero.coef(fit0, lambda.opt))
    coefs[[as.character(a)]] = coef.stability(coef.opt, cv.patient$non.zero.cf)
    
    plots[[as.character(a)]] = arrangeGrob(cv.patient$plot+ggtitle('Classification'), cv.patient$deviance.plot+ggtitle('Binomial Deviance'), top=paste('alpha=',a,sep=''), ncol=2)
    
    performance.at.1se[[as.character(a)]] = subset(cv.patient$lambdas, `lambda-1se`)
    models[[as.character(a)]] = fit0
    cvs[[as.character(a)]] = cv.patient
  }
  save(plots, coefs, performance.at.1se, dysplasia.df, models, cvs, labels, file=file)
  p = do.call(grid.arrange, c(plots[ as.character(alpha.values) ], top='All samples, 10fold, 5 splits'))
  ggsave(paste(cache.dir, '/', 'all_samples_cv.png',sep=''), plot = p, scale = 2, width = 12, height = 10, units = "in", dpi = 300)
}
all.coefs = coefs
save(arrayDf,labels,patient.info, file=paste(cache.dir,'snp.Rdata',sep='/'))
```