---
title: "sWGS Normals"
author: "Sarah Killcoyne"
date: "7/30/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(BarrettsProgressionRisk)
library(glmnet)
library(gridExtra)
library(pander)
source('lib/load_patient_metadata.R')
#source('lib/data_func.R')
#source('lib/fastPCF.R')

data.dir = '~/Data/BarrettsProgressionRisk/QDNAseq'
analysis.dir = '~/Data/BarrettsProgressionRisk/Analysis'
#data.files = list.files(, full.names = T)

modeldir = '~/Data/BarrettsProgressionRisk/Analysis/5e6_arms_all'

patient.file = list.files(data.dir, pattern='All_patient_info.xlsx', recursive=T, full.names=T)
demo.file = list.files(data.dir, pattern='Demographics_full.xlsx', recursive=T, full.names=T)

rpi = read.patient.info(patient.file, demo.file)
normals = rpi$normal

data.files = list.files(paste0(analysis.dir, '/normals'), 'segment.Rdata', recursive = T, full.names = T)


resids = do.call(bind_rows, purrr::map(list.files(paste0(analysis.dir, '/normals'), 'residuals.tsv', recursive = T, full.names = T), function(f) read_tsv(f)))

resids = sample.residual.variance(seg.residuals)
resids = merge(normals[,c('Patient','Hospital.Research.ID','Samplename')], resids, by.x='Samplename', by.y='sample')

failedQC = arrange(subset(resids, round(var1sd_median,3) > 0.012, select=c(Hospital.Research.ID,Samplename, var1sd_median,var1sd_sd, var1sd_Q1,var1sd_Q3)),  var1sd_median)


pander(normals[,c('Patient','Hospital.Research.ID','Status','Endoscopy.Year','Pathology notes')], caption='Normal samples', justify='left')
```


`r nrow(failedQC)` samples failed the variant residual QC based on a cutoff determined by the discovery cohort.


```{r, echo=F, warning=F, fig.height=30, fig.width=8}
do.call(grid.arrange, c(plist, ncol=1))
```

## Predictions

Using the model trained on the progressors and non-progressors in the initial cohort the normal samples can be predicted as well.

```{r, echo=F}

file = paste(modeldir, 'model_data.Rdata', sep='/')
if (!file.exists(file))
  stop(paste("Missing data file", file))
load(file, verbose=F)
file = paste(modeldir, 'all.pt.alpha.Rdata', sep='/')
if (!file.exists(file))
  stop(paste("Missing data file", file))
load(file, verbose=F)
rm(dysplasia.df,coefs,plots,labels)

select.alpha = '0.9'
fitV = models[[select.alpha]]
lambda.opt = performance.at.1se[[select.alpha]][, 'lambda']


tiled.segs = segment.matrix(tiled.normals)
tiled.arms = segment.matrix(tiled.normal.arms)

cx.score = score.cx(tiled.segs,1)

for (i in 1:ncol(tiled.segs)) 
  tiled.segs[,i] = unit.var(tiled.segs[,i], z.mean[i], z.sd[i])
for (i in 1:ncol(tiled.arms)) 
  tiled.arms[,i] = unit.var(tiled.arms[,i], z.arms.mean[i], z.arms.sd[i])

mergedDf = subtract.arms(tiled.segs, tiled.arms)
mergedDf = cbind(mergedDf, 'cx' = unit.var(cx.score, mn.cx, sd.cx))

sparsed_test_data <- Matrix(data=0, nrow=nrow(mergedDf),  ncol=ncol(mergedDf),
                            dimnames=list(rownames(mergedDf),colnames(mergedDf)), sparse=T)
for(col in colnames(mergedDf)) sparsed_test_data[,col] = mergedDf[,col]
  
preds = predict(fitV, newx=sparsed_test_data, s=lambda.opt, type='response')

high = preds[preds > 0.7,,drop=F]

pander(subset(normals, Samplename %in% rownames(high), select=c('Patient','Hospital.Research.ID','Status','Endoscopy.Year','Pathology notes')), caption='Normal samples predicted to be high risk')

```


