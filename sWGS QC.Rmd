---
title: "sWGS QC"
author: "Sarah Killcoyne"
date: "8/30/2018"
output: 
  html_document: 
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


library(tidyverse)
library(gridExtra)
library(kableExtra)


dir1 = '~/Data/Ellie/Analysis/multipcf_perPatient/'
dir2 = '~/Data/Ellie/Analysis/validation//'

```

## Initial sWGS dataset (Ellie's)

```{r, echo=F}

res.variance = do.call(bind_rows, lapply(list.files(dir1, 'residuals', recursive = T, full.names = T), function(f) {
  read_tsv(f, col_types = 'ccdddddl')
}))

#pander(head(res.variance[,grep('var1sd',colnames(res.variance))]), caption='Residuals across segments per sample')
kable(head(res.variance), caption='Example residuals across segments per sample') %>% kable_styling('striped')
```

```{r, echo=F, fig.height=10}
res.variance = arrange(res.variance,varMAD_median)
cutoff = round(median(res.variance$varMAD_median)+sd(res.variance$varMAD_median)*2, 3)
#cutoff = 0.015

grid.arrange(
  ggplot(res.variance,aes(sample=varMAD_median)) + stat_qq() + geom_hline(yintercept=cutoff, linetype='dashed',color='grey') + 
    labs(title='Normal Q-Q plot (all)', x='Theoretical quantiles',y='Sample quantiles') + theme_bw(),
  ggplot(subset(res.variance,varMAD_median < cutoff), aes(sample=varMAD_median)) + stat_qq() + 
    labs(title='Normal Q-Q plot (samples<cutoff)', x='Theoretical quantiles',y='Sample quantiles') + theme_bw(),
  top='var( seg<MAD(seg) | seg>-MAD(seg)  )'
)
```

```{r, echo=F}
ggplot(res.variance, aes(varMAD_median)) + geom_histogram(bins=50,color='lightblue') + 
  geom_vline(xintercept = cutoff, linetype='dashed', color='grey') + labs(x='var( seg<MAD(seg) | seg>-MAD(seg)  )') + theme_bw()
```

The cutoff=`r cutoff`. Samples with a variance greater than this are:

```{r, echo=F}
res.variance %>% filter( round(varMAD_median,3) > cutoff ) %>% select(patient,sample, varMAD_median) %>% kable(caption=paste0('Samples variance > ',cutoff)) %>% kable_styling('striped')

failedQC = res.variance %>% filter( round(varMAD_median,3) > cutoff ) 
```

`r nrow(failedQC)` samples (`r signif(nrow(failedQC)/nrow(res.variance)*100,2)`%) would have failed due to high variance across all the segments. A manual check of these agrees with most of these. One or two samples would appear to be driven by some extreme segments, and this could be further evaluated, and stricter cutoffs do pick up additional samples that are borderline.  However, this cutoff appears to be reasonable.

## Validation dataset

Cutoff from above dataset applied to the initial validation set.

```{r, echo=F}
val.file = '~/Data/BarrettsProgressionRisk/QDNAseq/validation/sWGS_validation_batches.xlsx'
sheets = readxl::excel_sheets(val.file)[1:4]
all.val = do.call(bind_rows, lapply(sheets, function(s) {
  readxl::read_xlsx(val.file, s) %>% select(`Hospital Research ID`, matches('Status'), `Block ID`,`Sample Type`, `SLX-ID`, `Index Sequence`, Cohort, Batch, RA, matches('Collection')) %>% dplyr::filter(!is.na(`SLX-ID`) & RA == 'C.Kosmidou') %>% mutate_at(vars(`SLX-ID`, `Block ID`), list(as.character)) 
}))
all.val = all.val %>% select(-Collection)

pastefun<-function(x) {
  if ( !grepl('SLX-', x) ) x = paste0('SLX-',x)
  return(x)
}

all.val = all.val %>% rowwise %>% mutate_at(vars(`SLX-ID`), list(pastefun) ) %>% ungroup
all.val = all.val %>% mutate(
  `Hospital Research ID` = str_replace_all( str_remove_all(`Hospital Research ID`, " "), '/', '_'), 
  `Index Sequence` = str_replace_all(`Index Sequence`, 'tp', ''),
  Sample = paste(`SLX-ID`,`Index Sequence`,sep='.')
  )


resVal = do.call(bind_rows, lapply(list.files(dir2, 'residuals', recursive = T, full.names = T), function(f) {
  readr::read_tsv(f, col_types = 'cdddddl', col_names = F) %>% set_names('sample', 'varMAD_median', 'varMAD_sd', 'varMAD_Q1', 'varMAD_Q3', 'n.segs', 'Pass') %>%  
    mutate(`Patient ID` = as.character(basename(dirname(f))))
})) %>% select(`Patient ID`, sample, matches('varMad'), n.segs, Pass) 


resVal = resVal %>% filter(sample %in% all.val$Sample)


resVal %>% kable(caption='Residuals across segments per sample') %>% kable_styling('striped')
resVal = arrange(resVal,varMAD_median)

ggplot(resVal,aes(sample=varMAD_median)) + stat_qq() + geom_hline(yintercept=cutoff, linetype='dashed',color='grey') + 
  labs(title='Normal Q-Q plot (all)', x='Theoretical quantiles',y='Sample quantiles') + theme_bw()

ggplot(resVal, aes(varMAD_median)) + geom_histogram(bins=50,color='lightblue') + 
  geom_vline(xintercept = cutoff, linetype='dashed', color='grey') + labs(x='var(median(segments)+1sd(segments))') +
  theme_bw()

failedQCVal = resVal %>% filter(varMAD_median > cutoff) %>% arrange(`Patient ID`, varMAD_median)

#setdiff(as.character(resVal$sample),as.character(failedQCVal$sample))

```

The result from this is that `r nrow(failedQCVal)` samples (`r signif(nrow(failedQCVal)/nrow(resVal)*100,3)`%) would have failed due to high variance across all the segments. A manual check of these agrees with all of them.


## If we learned it from all residuals

```{r}
res.variance = res.variance %>% mutate_at(vars(patient, sample), as.character)
resVal = resVal %>% dplyr::rename( patient = `Patient ID` ) %>% mutate_at(vars(patient, sample), as.character)

res.variance$cohort = 'discovery'
resVal$cohort = 'validation'

ar = bind_rows( res.variance, resVal ) %>% mutate(cohort = factor(cohort))

#newcutoff = round(median(ar$varMAD_median)+sd(ar$varMAD_median)*2, 3)
newcutoff = 0.015

ggplot(ar,aes(sample=varMAD_median)) + stat_qq() + geom_hline(yintercept=newcutoff, linetype='dashed',color='grey') + 
    labs(title='Normal Q-Q plot (all)', x='Theoretical quantiles',y='Sample quantiles') + theme_bw()

ggplot(ar, aes(varMAD_median)) + geom_histogram(bins=50,color='lightblue') + 
  geom_vline(xintercept = newcutoff, linetype='dashed', color='grey') + labs(x='var(MAD)') +
  theme_bw()

fc = ar %>% filter(round(varMAD_median,3) > newcutoff) %>% select(patient, sample, varMAD_median,varMAD_sd, varMAD_Q1,varMAD_Q3) %>% arrange(patient, varMAD_median)
```

Using the cutoff `r newcutoff` learned from all of them we would fail `r length(which(resVal$varMAD_median > newcutoff))` samples from the training dataset (Ellie's) and `r length(which(resVal$varMAD_median > newcutoff))` from the initial validation dataset. So while it's less stringent it still fails `r length(which(failedQCVal$varMAD_median > newcutoff))/nrow(resVal)*100`% versus `r length(which(failedQC$varMAD_median > newcutoff))/nrow(res.variance)*100`% of the training dataset.





