---
title: "SNP Analysis"
author: "Sarah Killcoyne"
date: "6/13/2018"
output: 
  html_document: 
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message = F, warning = F)
library(tidyverse)
library(gridExtra)
library(glmnet)
library(pROC)
#library(ggfortify)
library(BarrettsProgressionRisk)
library(pander)
library(kableExtra)
library(reshape2)

#source('~/workspace/shallowwgs_pipeline/lib/data_func.R')
source('~/workspace/shallowwgs_pipeline/lib/common_plots.R')



chr.info = BarrettsProgressionRisk:::chrInfo(build='hg19')

model.dir = '~/Data/Ellie/Analysis/models_5e6_all/50kb'
load(paste0(model.dir,'/model_data.Rdata'), verbose = F)
load(paste0(model.dir,'/all.pt.alpha.Rdata'), verbose = F)

alpha = '0.9'
fitV = models[[alpha]]
l = performance.at.1se[[alpha]]$lambda
features = coefs[[alpha]]

swgs_labels = labels

patient.info = readxl::read_xlsx('~/Data/BarrettsProgressionRisk/Analysis/SNP/metadata_T1T2.xlsx') %>% 
  mutate( UniqueSampleID = paste(PatientID, `Timepoint Code`, sep='_'), Path.Status = Status, PatientID = as.character(PatientID)) %>% 
  mutate(Path.Status = as.character(ifelse(Pathology %in% c('IMC','HGD'), 'P', Path.Status))) 

patient.info %>% filter(PatientID == 524)

rm(plots,performance.at.1se,models,cvs,labels)

load('~/Data/Reid_SNP/PerPatient/allpts_ascat.Rdata', verbose=T)

qcdata = qcdata %>% as_tibble %>%  mutate(Samplename = sub('_$','',Samplename)) %>%
  separate(Samplename, c('PatientID','SampleID','EndoID','Level'), sep='_', remove=F)

qcdata[749, 'Level'] = 'BLD' # Making an assumption here but this is what it looks like

segments.list = lapply(segments.list, function(pt) {
  pt$sample = sub('\\.LogR','',pt$sample)
  pt %>% as_tibble
})

calc.ratio<-function(PatientID, Samplename,Ploidy) {
  smp = filter( segments.list[[ PatientID ]], sample == Samplename & chr %in% c(1:22) )
  smp = smp %>% dplyr::mutate(
      #'Total' = nAraw + nBraw,
      'Total' = nMajor + nMinor,
      'CNV' = round(Total) - round(as.numeric(Ploidy)) )
  x = filter(smp, CNV != 0 & chr %in% c(1:22))
  return(sum(x$endpos - x$startpos)/as.numeric(chr.info[22,'genome.length']))
}

qcdata = qcdata %>% mutate(
  ASCAT.SCA.ratio = purrr::pmap_dbl(list(PatientID, Samplename, Ploidy), .f=calc.ratio),
  Level = toupper(Level),
  SampleType = case_when(
    grepl('BLD', Level, ignore.case = T) ~ 'Blood Normal',
    grepl('gastric', Level, ignore.case = T) ~ 'Gastric Normal',
    TRUE ~ 'BE'
)) 

sample.list = readxl::read_xlsx('~/Data/BarrettsProgressionRisk/Analysis/SNP/20180604_Reid_1M_SampleList.xlsx', sheet = 2) %>%
  dplyr::rename('Total.SCA' = 3) %>% mutate(SCA.Ratio = Total.SCA/max(chr.info$genome.length))

sample.info = dplyr::select(qcdata, c('PatientID','SampleID','EndoID','Level','Samplename','ASCAT.SCA.ratio'))

message(paste(length(unique(sample.info$PatientID)), 'patients listed in metadata file'))
message(paste(nrow(qcdata), 'samples available'))

sample.info = left_join(sample.info, patient.info[,c('PatientID','Timepoint','Timepoint Code','Status','Pathology')], by=c('PatientID','EndoID' = 'Timepoint Code')) %>%
  mutate(Status = factor(as.character( ifelse(is.na(Status) & Level %in% c('BLD','GASTRIC'), 'Normal', Status))))
head(sample.info)

get.ratio<-function(PID, SID) {
  subset(sample.list, PatientID == PID & SampleNum == SID)$SCA.Ratio
}

sample.info = sample.info %>% rowwise() %>% dplyr::mutate(
  SCA.Ratio = ifelse(Level %in% c('BLD','GASTRIC'), 0, get.ratio(PatientID, SampleID)), 
  Endoscopy = ifelse(Timepoint == 'T1', 1, 2)
)

ggplot(sample.info, aes(ASCAT.SCA.ratio, SCA.Ratio)) + geom_point() + facet_grid(~Status)


ct = cor.test(sample.info$ASCAT.SCA.ratio, sample.info$SCA.Ratio)
```

ASCAT and Xiahong's estimates show a `r round(ct$estimate,2)` correlation. That suggests that the remainder is due to the LOH I'm not trying to call.


## Patient info 

`r nrow(patient.info)` total endoscopies, `r patient.info %>% group_by(Status) %>% tally %>% spread(Status,n) %>% kable(caption="Split between P and NP") %>% kable_styling(full_width=F)`

Histology breakdown:

```{r, echo=F}
sm = sample.info %>% group_by(Status, Endoscopy, Pathology) %>% dplyr::tally() %>% group_by(Status, Endoscopy) %>% dplyr::mutate(freq=n/sum(n) )
sm$Pathology = factor(sm$Pathology, levels=c('NDBE','ID','LGD','HGD','IMC'), ordered = T)

ggplot(sm %>% filter(!Status == 'Normal'), aes(Pathology, freq, group=Endoscopy, fill=factor(Endoscopy))) + facet_grid(~Status) + 
  geom_col(position = position_dodge()) + ylim(0,1) + labs(title='Pathology frequency per timepoint')
```


There's a significant difference in the numbers of NDBE or HGD samples between the groups
```{r, echo=F}
pander(chisq.test(table(patient.info$Pathology, patient.info$Status)['HGD',]), caption='HGD')
pander(chisq.test(table(patient.info$Pathology, patient.info$Status)['NDBE',]), caption='NDBE')

# Most progressors are HGD at timepoint 1
pander( round(with(subset(sample.info, Endoscopy == 1), table(Pathology, Status))['HGD',]/table(subset(sample.info, Endoscopy == 1)$Status), 3)*100, caption='% HGD at T1')
```

# Quick QC 

Purity, ploidy and goodnessoffit from single sample (not paired) ASCAT.

```{r, echo=F, warning=F, message=F}
qcdata = left_join(qcdata, sample.info[,c('Samplename','Status','Timepoint','SCA.Ratio')], by='Samplename')

ggplot(qcdata, aes(Status, ASCAT.SCA.ratio, color=Status, group=Status)) + geom_boxplot() + facet_grid(~SampleType)

low = subset(qcdata, SampleType == 'BE' & ASCAT.SCA.ratio <= median(subset(qcdata, SampleType != 'BE')$ASCAT.SCA.ratio))

anno = cbind.data.frame(table(subset(qcdata, SampleType == 'BE' & ASCAT.SCA.ratio <= median(subset(qcdata, SampleType != 'BE')$ASCAT.SCA.ratio))$Status)/table(subset(qcdata, SampleType == 'BE')$Status))
colnames(anno) = c('Status','Ratio')
anno$label='median(normal SCA)'
anno$x = 0.4
anno$y = median(subset(qcdata, SampleType != 'BE')$ASCAT.SCA.ratio)


ggplot(subset(qcdata,SampleType == 'BE'), aes(Purity, ASCAT.SCA.ratio, color=Status, group=Status)) + geom_point() + facet_grid(~Status, scales = 'free') + ylim(0,0.01) + 
  geom_hline(yintercept = anno$y[1]) + geom_text(data=anno, aes(x, y, label=label), nudge_y = 0.0001) +
  geom_text(data=anno, aes(x, y, label=paste(round(Ratio,2)*100,'% samples',sep='')), nudge_y = -0.0001)

ggplot(qcdata, aes(Ploidy, ASCAT.SCA.ratio, color=Status)) + geom_point() + facet_grid(~SampleType)

ggplot(qcdata, aes(Ploidy, ASCAT.SCA.ratio, color=Status)) + geom_point() + facet_grid(~Status)

ggplot(subset(qcdata,SampleType == 'BE'), aes(Timepoint, ASCAT.SCA.ratio, color=PatientID, group=Timepoint)) + geom_boxplot() + 
  facet_wrap(~Status, scales='free_x', ncol=2) + labs(title='SCA Ratio by Timepoint') + theme(legend.position = 'none')

ggplot(qcdata, aes(round(Ploidy,2))) + geom_histogram() + 
  facet_wrap(~SampleType, ncol=1) + labs(x='Ploidy', title='Ploidy, normal vs BE')

ggplot(qcdata, aes(round(Purity,2))) + geom_histogram() + 
  facet_wrap(~SampleType, scales='free', ncol=1) + labs(x='Purity', title='Purity, normal vs BE')

#x=median(qcdata$SCA.Ratio,na.rm=T)+sd(qcdata$SCA.Ratio,na.rm=T)
x=0.05
y=median(qcdata$Purity,na.rm=T)-sd(qcdata$Purity,na.rm=T)/2

ggplot(qcdata, aes(Purity, ASCAT.SCA.ratio, color=ASCAT.SCA.ratio < 0.2)) + geom_point() + 
         facet_wrap(~Status, ncol=1) + labs(title='Purity~SCA.Ratio') + geom_vline(xintercept=y, color='grey')

ggplot(qcdata, aes(ASCAT.SCA.ratio, Purity, color=Status)) + geom_point() + 
  facet_wrap(~Status) + labs(x='SCA', title='SCA vs Purity') + 
  geom_vline(xintercept = x, color='grey') + geom_hline(yintercept = y, color='grey')

table(unique(subset(qcdata, Purity > y & ASCAT.SCA.ratio < x & SampleType == 'BE', select=c('Status','PatientID')))$Status)

ggplot(qcdata, aes(Purity)) + geom_histogram() + geom_vline(xintercept = y, col='red') + 
  facet_wrap(~SampleType, scales = 'free') + labs(title='Purity by sampletype')

ggplot(qcdata, aes(Purity, Goodnessoffit, color=Status)) + geom_point() + 
         facet_wrap(~SampleType, ncol=1) + labs(title='Purity~fit, normal vs BE') + geom_vline(xintercept=y, color='grey')

ggplot(subset(qcdata, SampleType == 'BE'), aes(round(Ploidy,2), Purity, color=Status)) + geom_point() + facet_grid(~Status) + 
  labs(title='BE only, purity vs ploidy') + geom_hline(yintercept=y, color='grey')

ggplot(qcdata, aes(ASCAT.SCA.ratio, color=Status, fill=Status)) + facet_wrap(~Status, scales='free_y',nrow=1) +  geom_density(alpha=0.5) + labs(x='SCA Ratio', title='SCA Ratio, NP vs P') 

ggplot(qcdata, aes(ASCAT.SCA.ratio, color=Status, fill=Status)) + facet_wrap(Status~SampleType, scales='free_y',nrow=2) +  geom_density(alpha=0.5) + labs(title='SCA Ratio, NP vs P') 

summary(subset(qcdata, SampleType == 'BE')$ASCAT.SCA.ratio)
summary(subset(qcdata, SampleType != 'BE')$ASCAT.SCA.ratio)

ggplot(subset(qcdata, SampleType == 'BE'), aes(Purity, ASCAT.SCA.ratio, color=Status)) + facet_grid(~Status) +
  geom_point() + geom_vline(xintercept = y, color='darkgreen') + geom_hline(yintercept = x, color='red') + 
  labs(title='Barretts only')

ggplot(subset(qcdata, SampleType == 'BE'), aes(Ploidy, ASCAT.SCA.ratio, color=Status)) + facet_grid(~Status) + geom_point() + 
  geom_hline(yintercept = 0.02, color='red') + labs(title='Barretts only')

## PER ENDOSCOPY
qcdata.endo = qcdata %>% group_by(PatientID, EndoID, Status, Timepoint, SampleType) %>% dplyr::summarise_if(is.numeric, c('mean','max','min','sd')) %>% mutate_if(is.numeric, round, digits=3)
qcdata %>% dplyr::group_by( Status, SampleType) %>% dplyr::summarise( median(ASCAT.SCA.ratio), sd(ASCAT.SCA.ratio) )


#ggplot(subset(qcdata.endo, SampleType == 'BE'), aes(ASCAT.SCA.ratio_max, Purity_max)) + geom_point() + facet_grid(~Status) + geom_hline(yintercept = 0.95)  + geom_vline(xintercept = 0.001)

lowsca = subset(qcdata.endo, SampleType == 'BE' & ASCAT.SCA.ratio_max <= 0.01 & Purity_max > 0.98 )

#table(unique(lowsca[,c('PatientID','Status')])$Status)/table(unique(qcdata.endo[,c('PatientID','Status')])$Status)

#table(unique(subset(qcdata.endo, SampleType == 'BE' & ASCAT.SCA.ratio_max <= 0.001, select=c('PatientID','Status')))$Status)
  

ggplot(subset(qcdata.endo,SampleType == 'BE'), aes(Status, ASCAT.SCA.ratio_max, group=Status)) + geom_boxplot() + geom_hline(yintercept = 0.002, color='red')

qcdata %>% dplyr::group_by( Status, SampleType) %>% dplyr::summarise( median(ASCAT.SCA.ratio))


```


# Load tiled data

CN Adjustment uses Annalise's whole-genome non-progressor samples to generate a set of mean and SD values per copy-number state. The median LogR values are adjusted using the mean and SD based on the CN state.  The adjusted LogR values are then winsorize per sample, and tiled in 5Mb bins.

```{r, warning=F, echo=F, message=F, fig.height=10, fig.width=8}

if (file.exists('~/Data/Reid_SNP/PerPatient/tmp_seg_pt.Rdata')) {
  load('~/Data/Reid_SNP/PerPatient/tmp_seg_pt.Rdata', verbose=T) 
} else {
  ptdirs = list.dirs('~/Data/Reid_SNP/PerPatient', recursive = F)
  mergedSegs = NULL;  mergedArms = NULL
  length(ptdirs)
  
  for (pt in ptdirs) {
    print(pt)
    if (length(list.files(pt, '*wins_tiled.txt', full.names=T)) <= 0) {
      message(paste("No tiled files for",pt))
      next
    }
  
    
    segvals = read_tsv(list.files(pt, '*wins_tiled.txt', full.names=T), col_types = cols(.default = col_double(), 'X1'= col_character())) %>% dplyr::rename(Samplename = X1)
    armvals = read_tsv(list.files(pt, '*arms_tiled.txt', full.names=T), col_types = cols(.default = col_double(), 'X1'= col_character())) %>% dplyr::rename(Samplename = X1)
    #samplenames = segvals$Samplename
    
    segvals = segvals %>% set_rownames(.$Samplename) %>% dplyr::select(-Samplename) %>% as.matrix 
    armvals = armvals %>% set_rownames(.$Samplename) %>% dplyr::select(-Samplename) %>% as.matrix 
    

    #segvals[is.na(segvals)] = mean(segvals,na.rm=T)
    #armvals[is.na(armvals)] = mean(armvals,na.rm=T)
  
    if (is.null(segvals) | is.null(armvals))
      stop(paste("Missing values in ", pt))
    
    if (is.null(mergedSegs)) {
      mergedSegs = segvals
      mergedArms = armvals
    } else {
      mergedSegs = rbind(mergedSegs, segvals)    
      mergedArms = rbind(mergedArms, armvals)    
    }
  }
  nrow(mergedSegs) == nrow(mergedArms)
  #setdiff(rownames(mergedSegs), rownames(mergedArms))
  dim(mergedSegs)
  
  save(mergedSegs, mergedArms, file='~/Data/Reid_SNP/PerPatient/tmp_seg_pt.Rdata')
}

rownames(mergedSegs) = sub('\\.LogR','', rownames(mergedSegs))
rownames(mergedArms) = sub('\\.LogR','', rownames(mergedArms))

dim(mergedSegs)
dim(mergedArms)

# Adjust for ploidy -- this was done in the processing
# for (i in 1:nrow(mergedSegs)) {
#   sample = rownames(mergedSegs)[i]
#   x = unlist(strsplit(sample, '_'))
#   #ploidy = mean(subset(qcdata, SampleType == 'BE' & PatientID == x[1] & EndoID == x[2])$Ploidy)
#   ploidy = subset(qcdata.endo, PatientID == x[1] & EndoID == x[2] & SampleType == 'BE')$Ploidy_mean
#   if (grepl('BLD|gastric', sample, ignore.case = T)) ploidy = 2
#   mergedSegs[i,] = mergedSegs[i,]-(ploidy-1)
#   mergedArms[i,] = mergedArms[i,]-(ploidy-1)
# }

segmentVariance = apply(mergedSegs, 1, var)


nm.rows = grep('BLD|GASTRIC', rownames(mergedSegs))
#normalSegs = mergedSegs[nm.rows,]
#normalArms = mergedArms[nm.rows,]

# nrow(normalSegs) == nrow(normalArms)
# 
# mergedSegs = mergedSegs[-nm.rows,]
# mergedArms = mergedArms[-nm.rows,]
# 
# nrow(mergedSegs) == nrow(mergedArms)

lowSeg = mergedSegs[grep('^403', rownames(mergedSegs), value=T),,drop=F]
p1 = ggplot(melt(lowSeg), aes(Var2, value)) + facet_grid(~Var1, space='free_x', scales='free') + geom_point() +
  theme(axis.text.x=element_blank() ) + labs(title='Low SCA samples', subtitle='patient 403')

highSeg = mergedSegs[grep('^512', rownames(mergedSegs), value=T),,drop=F]
p2 = ggplot(melt(highSeg), aes(Var2, value)) + facet_grid(~Var1, space='free_x', scales='free') + geom_point() +
  theme(axis.text.x=element_blank() ) + labs(title='Mixed SCA samples', subtitle='patient 512')

grid.arrange(p1,p2,ncol=1)
```

# Values in the binned segments

Blood/gastric normals have very little variance compared to all of the BE samples (no idea which is P vs NP)

```{r normals, message=F, fig.height=10, fig.width=8}
#nm = melt(normalSegs)
nm = melt(mergedSegs[nm.rows,])
be = melt(mergedSegs[-nm.rows,])

lims = range(nm$value, be$value, na.rm=T)

grid.arrange(
  ggplot(nm, aes(Var2, value, group=Var2)) + geom_point() + labs(title='Blood/gastric',subtitle=paste('variance=',var(nm$value),sep=''),x='') + 
    theme(axis.text.x = element_blank()) + ylim(lims),
  ggplot(be, aes(Var2, value, group=Var2)) + geom_point() + labs(title='BE samples',subtitle=paste('variance=',var(be$value,na.rm=T),sep=''),x='') + 
    theme(axis.text.x = element_blank()) + ylim(lims)
)

```



## Compare the binned values to the median LRR from ASCAT

Using a random normal sample and a known BE progresser sample

```{r rnormals, echo=F, warning=F, message=F, fig.width=10, fig.height=8, eval=T}

adjust.cols<-function(df, means, sds) {
  nms = colnames(df)
  
  for (n in nms)
    df[,n] = BarrettsProgressionRisk:::unit.var(df[,n]+0.90, means[[n]], sds[[n]])
  
  return(df)  
}


randNormal = sample( grep('BLD',rownames(mergedSegs)[nm.rows], value=T), 1)
pt = unlist(strsplit(randNormal, '_'))[1]
segs = subset(segments.list[[pt]], chr %in% c(1:22) & grepl(sub('_', '.*', randNormal),sample))
segs$chr = factor(segs$chr, levels=c(1:22), ordered = T)

lims = range(segs$medLRR, mergedSegs[randNormal,])

grid.arrange(
  ggplot(segs) + facet_grid(~chr, space='free_x', scales='free')  +
    geom_segment(aes(x=startpos, xend=endpos, y=medLRR, yend=medLRR), size=3) +
    theme(axis.text.x=element_blank() ) + labs(title='Median LRR, ASCAT segments', subtitle=pt),

  ggplot(melt(as.matrix(mergedSegs[sub('\\.LogR','',randNormal),])), aes(Var1, value)) + geom_point() +
        theme(axis.text.x=element_blank()) + labs(title='Ploidy adjusted CN, binned'),

   ggplot(melt(t(adjust.cols(mergedSegs, z.mean, z.sd)[randNormal,])), aes(x=Var2, y=value)) + geom_point() + 
    theme(axis.text.x=element_blank()) + labs(title='Col adjusted CN, binned'),
 top='Random BLD or gastric normal', bottom=randNormal)


#randBE = '512_133R'
randBE = '1006_190V'
pt = unlist(strsplit(randBE, '_'))[1]
segs = subset(segments.list[[pt]], chr %in% c(1:22) & grepl(sub('_', '.*',randBE), sample))
segs$chr = factor(segs$chr, levels=c(1:22), ordered = T)

lims = range(segs$medLRR, mergedSegs[sub('\\.LogR','',randBE),])
grid.arrange(
  ggplot(segs) + facet_grid(~chr, space='free_x', scales='free')  +
    geom_segment(aes(x=startpos, xend=endpos, y=medLRR, yend=medLRR), size=3) +
    theme(axis.text.x=element_blank() ) + labs(title='Median LRR, ASCAT segments', subtitle=pt),

  ggplot(melt(as.matrix(mergedSegs[sub('\\.LogR','',randBE),])), aes(Var1, value)) + geom_point() +
    theme(axis.text.x=element_blank()) + labs(title='Ploidy adjusted CN, binned'),

   ggplot(melt(t(adjust.cols(mergedSegs, z.mean, z.sd)[randBE,])), aes(x=Var2, y=value)) + geom_point() + 
    theme(axis.text.x=element_blank()) + labs(title='Col adjusted CN, binned'),
top='BE', bottom=randBE)

```


# Set up values to predict

## Adjust per column

Adjust using the RAW values...

```{r raw.adjust, fig.height=16, fig.width=4, echo=T}
q.norm.by<-function(df, target) {
  dfq = do.call(cbind.data.frame,lapply(1:ncol(df), function(i) {
    as.data.frame(normalize.quantiles.use.target(df[,i,drop=F], as.vector(target[,i])))
  }))
  
  colnames(dfq) = colnames(df)
  rownames(dfq) = rownames(df)
  
  return(as.matrix(dfq))
}

#copySegs = q.norm.by(mergedSegs, raw.segs)
#copyArms = q.norm.by(mergedArms, raw.arms)

training = do.call(bind_rows, purrr::map(list.files('~/Data/BarrettsProgressionRisk/Analysis/pcf_perPatient/50kb', '5e06_tiled_segvals.txt', full.names = T, recursive = T), function(f) {
  read_tsv(f, col_types = cols(.default=col_double(), 'X1'=col_character()))
}))
training.segs = as.matrix(training[,-1]); rownames(training.segs) = training$X1

training = do.call(bind_rows, purrr::map(list.files('~/Data/BarrettsProgressionRisk/Analysis/pcf_perPatient/50kb', 'arms_tiled_segvals.txt', full.names = T, recursive = T), function(f) {
  read_tsv(f, col_types = cols(.default=col_double(), 'X1'=col_character()))
}))
training.arms = as.matrix(training[,-1]); rownames(training.arms) = training$X1

median(training.segs)
median(mergedSegs)
median(mergedSegs + 0.98)


median(training.arms)
median(mergedArms)
median(mergedArms + 0.98)


mergedSegs = mergedSegs + 0.98
mergedArms = mergedArms + 0.98

merged = rbind(mergedSegs, training.segs)
merged.mean = apply(merged, 2, mean, na.rm=T)
merged.sd = apply(merged, 2, sd, na.rm=T)

for (i in 1:ncol(mergedSegs))
  mergedSegs[,i] = BarrettsProgressionRisk:::unit.var(mergedSegs[,i], merged.mean[i], merged.sd[i])

merged.arms = rbind(mergedArms, training.arms)
merged.arms.mean = apply(merged.arms, 2, mean, na.rm=T)
merged.arms.sd = apply(merged.arms, 2, sd, na.rm=T)

for (i in 1:ncol(mergedArms))
  mergedArms[,i] = BarrettsProgressionRisk:::unit.var(mergedArms[,i], merged.arms.mean[i], merged.arms.sd[i])

# grid.arrange(
#   ggplot( melt(raw.segs), aes(sample=value)) + stat_qq() + labs(title='Normal Q-Q plot, sWGS bins (no arms)'),
#   ggplot( melt(mergedSegs), aes(sample=value)) + stat_qq() + labs(title='Normal Q-Q plot, SNP bins (no arms)')
#   ggplot( melt(copySegs), aes(sample=value)) + stat_qq() + labs(title='Normal Q-Q plot, SNP bins q-normed')
# )


normal.ids = sample.info %>% filter(grepl('BLD|gastric', Level, ignore.case=T)) %>% dplyr::summarise(rows = paste0(PatientID, '_', EndoID)) %>% pull

nm.rows = which(rownames(mergedSegs) %in% normal.ids)



```


```{r echo=F,message=F, fig.width=10, fig.height=8}
#cxN = score.cx(ns, 1)
#arrayDfNorm = subtract.arms(ns, na)
#arrayDfNorm = cbind(ns, na)
#arrayDfNorm = cbind(arrayDfNorm, 'cx'=unit.var(cxN, mn.cx, sd.cx))

#probN = predict(fitV, newx=arrayDfNorm, s=l, type='response')
#length(which(probN > 0.5))/nrow(probN) # FPR
#length(which(probN <= 0.5))/nrow(probN)

#preds.normal = cbind.data.frame(rownames(probN),probN, predict(fitV, newx=arrayDfNorm, s=l, type='link'))
#colnames(preds.normal) = c('Samplename','Prob', 'RR')

cx = BarrettsProgressionRisk:::scoreCX(mergedSegs, 1)
#arrayDf = cbind(ms,ma)
arrayDf = BarrettsProgressionRisk:::subtractArms(mergedSegs, mergedArms)
#arrayDf = cbind(arrayDf, 'cx'=unit.var(cx, mn.cx, sd.cx))
arrayDf = cbind(arrayDf, 'cx'=BarrettsProgressionRisk:::unit.var(cx, mn.cx, sd.cx))

lims=range(arrayDf, dysplasia.df,na.rm=T)
grid.arrange(
  ggplot(melt(arrayDf), aes(Var2, value)) + geom_point() + ylim(lims) +
    geom_point(data=melt(arrayDf[,589:634]), col='red') + labs(title='SNP'),
  ggplot(melt(dysplasia.df), aes(Var2, value)) + geom_point() + ylim(lims) +
      geom_point(data=melt(dysplasia.df[,589:634]), col='red') + labs(title='sWGS'),
nrow=1)

```


# Predictions

```{r, warning=F, fig.height=8}

prob = predict(fitV, newx=arrayDf, s=l, type='response')
rr = predict(fitV, newx=arrayDf, s=l, type='link')

preds = bind_cols('Samplename'=rownames(prob),'Prob'=prob[,1],'RR'=rr[,1]) %>%
  mutate(Risk = case_when(
    Prob <= 0.3 ~ 'Low',
    Prob > 0.3 & Prob < 0.5 ~ 'Moderate',
    Prob >= 0.5 ~ 'High' 
))

normals = filter(preds, grepl('BLD|gastric', Samplename, ignore.case=T))
table(normals$Risk)

preds = filter(preds, !grepl('BLD|gastric', Samplename, ignore.case=T))

preds = preds %>% left_join(patient.info %>% dplyr::select(UniqueSampleID, Pathology, Status), by=c('Samplename'='UniqueSampleID')) %>%
   mutate(Status = as.character(ifelse(Pathology %in% c('HGD','IMD'), 'P', Status)))

preds %>% group_by(Status, Risk) %>% tally %>% spread(Risk,n)

hist(preds$Prob)

length(which(normals$Prob > 0.5))/nrow(normals) # FPR
length(which(normals$Prob < 0.5))/nrow(normals) 

myPal = rev(RColorBrewer::brewer.pal(11, 'RdYlBu'))
grid.arrange(
  ggplot(preds, aes(RR)) + geom_histogram(aes(fill=..x..), bins=15, show.legend = F) +
    scale_fill_gradientn(colors = myPal,  name='') + 
    labs(y='n Samples', x='Relative Risk', title='Unadjusted relative risk'),
  # ggplot(preds, aes(`Adj. RR`)) + geom_histogram(aes(fill=..x..), bins=15, show.legend = F) +
  #   scale_fill_gradientn(colors = myPal,  name='') +
  #   labs(y='n Samples', x='Relative Risk', title='Adjusted relative risk'),
top='Relative risk')


grid.arrange(
  ggplot(preds, aes(Prob)) + geom_histogram(aes(fill=..x..), breaks=seq(0,1,0.1) , show.legend = F) +
    scale_fill_gradientn(colors = myPal,  name='') + 
    labs(title='Predictions, all samples model', y='n Samples', x='Unadjusted Probability'),
  # ggplot(preds, aes(`Adj. Prob`)) + geom_histogram(aes(fill=..x..), breaks=seq(0,1,0.1) , show.legend = F) +
  #   scale_fill_gradientn(colors = myPal,  name='') +
  #   labs(title='Predictions, all samples model', y='n Samples', x='Adjusted Probability'),
top='Probability') 


#preds = sample.info %>% mutate(Sample = paste(PatientID,EndoID,sep='_')) %>% left_join(preds, by=c('Sample'='Samplename'))

summary(preds$Prob)

preds %>% group_by(Status, Risk) %>% tally %>% spread(Risk, n) %>%
  left_join(preds %>% group_by(Status) %>% tally, by='Status') %>%
  mutate_if(is.numeric, list( round(./n,2))) %>% 
  dplyr::select(-n)


roc = pROC::roc(Status ~ Prob, data=preds, auc=T, ci=T, of='thresholds',transpose=T)
roc.plot(roc) + labs(title='SNP AUC by (P)')
pROC::coords(roc, 'best')

preds = preds %>%
  mutate(LH = ifelse(Prob > 0.5, 'High', 'Low')) %>%
  mutate(LH = factor(LH, levels=c('Low','High'), ordered=T))


rocR = pROC::roc(Status ~ LH, data=preds, auc=T, ci=T, of='thresholds',transpose=T)
roc.plot(rocR) + labs(title='SNP AUC by discretized risks (low/high)')
pROC::coords(rocR, 'best')

```

A quick look at the two random samples from earlier.  
`r pander(subset(normals, Samplename == randNormal), caption='Random normal')`

The random BE should show a very high probability, and it does...
`r pander(subset(preds, Samplename == randBE), caption='Random BE')`

In the gastric/blood normals `r signif(length(which(preds.normal$Prob < 0.5))/nrow(preds.normal),2)` are predicted to have <50% probability (TPR).

For blood normals only `r signif(nrow(subset(preds.normal, grepl('BLD',Samplename) & Prob < 0.5))/nrow(subset(preds.normal, grepl('BLD',Samplename) )),2)` have a <50% probabilitye (TPR).


## Evaluating predictions

```{r, warning=F, fig.height=8}
#qcdata.be = subset(qcdata, SampleType == 'BE')
# get.qcinfo<-function(vec) {
#   endo = vec[2]
#   pt = vec[1]
#   y = subset(qcdata.be, PatientID == pt & EndoID == endo)
#   y = y %>% group_by(Status, Timepoint) %>%  dplyr::summarise( mean(Ploidy), mean(Purity), mean(Goodnessoffit), mean(SCA.Ratio) )
#   cbind.data.frame('PatientID'=pt, 'EndoID'=endo, y, stringsAsFactors = F)
# }
preds = preds %>% dplyr::group_by(Samplename) %>% dplyr::mutate(
  PatientID = unlist(strsplit(Samplename,'_'))[1],
  EndoID = unlist(strsplit(Samplename,'_'))[2]
)

#pred.qc = left_join(preds, qcdata.endo %>% dplyr::select(-SampleType), by=c('PatientID', 'EndoID', 'Status')) %>% data.frame


#grid.arrange(
#  ggplot(pred.qc, aes(ASCAT.SCA.ratio_mean, Prob, color=Status)) + geom_point(),
 # ggplot(pred.qc, aes(Ploidy_max, Prob, color=Status)) + geom_point(),
#ncol=2)

#pander(cor.test(pred.qc$ASCAT.SCA.ratio_mean, pred.qc$Prob))
```

```{r, warning=F, fig.height=8, eval=F}
prog = subset(pred.qc, Status == 'P')
p1 = ggplot(prog, aes(Prob)) + facet_wrap(~Timepoint, scales='free_y',nrow=1) + 
  geom_histogram(aes(fill=..x..), breaks=seq(0,1,0.1) , show.legend = F) +
  scale_fill_gradientn(colors = myPal,  name='') + 
  labs(title='Predictions on progressors', y='n Samples', x='Unadjusted Probability')

nonprog = subset(pred.qc, Status == 'NP')
p2 = ggplot(nonprog, aes(Prob)) + facet_wrap(~Timepoint, scales='free_y', nrow=1) + 
  geom_histogram(aes(fill=..x..), breaks=seq(0,1,0.1) , show.legend = F) +
  scale_fill_gradientn(colors = myPal,  name='') + 
  labs(title='Predictions on non-progressors', y='n Samples', x='Unadjusted Probability')

preds.normal = preds.normal %>% dplyr::mutate(Type = ifelse(grepl('BLD',Samplename), 'Blood','Gastric'))

p3 = ggplot(preds.normal, aes(Prob)) + facet_wrap(~Type, ncol=2, scales = 'free') +
  geom_histogram(aes(fill=..x..), breaks=seq(0,1,0.1) , show.legend = F) +
  scale_fill_gradientn(colors = myPal,  name='') +
  labs(title='Predictions on BLD/Gastric', y='n Samples', x='Unadjusted Probability')

grid.arrange(p1,p2,p3,ncol=1)

```


# Compare predictions to known status

Using my thresholds

```{r roc, echo=T, eval=F}
pred.qc = base::merge( pred.qc, patient.info[,c('PatientID', 'Timepoint Code','Pathology')], by.x=c('PatientID', 'EndoID'), by.y=c('PatientID','Timepoint Code') )

# Three groups, prog, non prog (max LGD), non prog (max HGD)
# pred.qc = pred.qc %>% group_by(Status, PatientID) %>% dplyr::mutate( 
#   exclude=(Status == 'NP' & (length(which(Pathology == 'HGD')) > 0 | `mean(Ploidy)` > 2.7 )) )
pred.qc$Status = factor(pred.qc$Status)

pred.qc = pred.qc %>% group_by(Status, PatientID) %>% dplyr::mutate(
  exclude=(Status == 'NP' & (length(which(Pathology == 'HGD')) > 0)),
  wgd = (Status == 'NP' & Ploidy_max > 2.7 )
)

# pred.qc = pred.qc %>% group_by(Status, Samplename) %>% dplyr::mutate(
#   lowsca = ( Status == 'P' & (`mean(SCA.Ratio)` < 0.03 & `mean(Purity)` >= 0.95))
# )

pred.qc = pred.qc %>% group_by(Status, Samplename) %>% dplyr::mutate(
  lowsca = ( ASCAT.SCA.ratio_mean < 0.02 & Purity_mean > 0.95)
)

ggplot(pred.qc, aes(ASCAT.SCA.ratio_mean, Purity_mean, color=lowsca)) + geom_point() + facet_grid(~Status) + 
  geom_vline(xintercept=0.02) + geom_hline(yintercept = 0.95)


pander(
  rbind(rbind('n.Samples'=table(subset(pred.qc, !lowsca )$Status)),
  rbind('n.Patients'=table(unique(subset(pred.qc, !lowsca, select=c('PatientID','Status')))$Status))),
caption='Number of samples and patients that pass the low SCA:high purity thresholds')



pander(
  rbind(rbind('n.Samples'=table(subset(pred.qc, !lowsca & !exclude & !wgd)$Status)),
  rbind('n.Patients'=table(unique(subset(pred.qc, !lowsca  & !exclude & !wgd, select=c('PatientID','Status')))$Status))),
caption='Number of samples and patients that pass the low SCA:high purity & NP thresholds')


```


```{r echo=F, eval=F}
pred.qc.ex = subset(pred.qc, SampleType == 'BE' & !exclude & !wgd & !lowsca)
cuts = seq(0,1,0.1)

pred.qc.ex$quants = with(pred.qc.ex, cut(Prob, breaks=cuts))
qt = as.data.frame.matrix(table(pred.qc.ex$quants, pred.qc.ex$Status))
qt$quant = rownames(qt)
qt$P = round(qt$P/sum(qt$P),2)
qt$NP = round(qt$NP/sum(qt$NP), 2)
pander(qt, caption='Excluding HGD NP, WGD NP, low SCA P')

# These are the cutoffs from the sWGS data
get.risk<-function(prob) {
  if (prob < 0.3) return('Low')
  if (prob >= 0.3 & prob < 0.7) return('Moderate')
  if (prob >= 0.7) return('High')
}

# All data
pred.qc = pred.qc %>% dplyr::rowwise() %>% dplyr::mutate(
  Risk = get.risk(Prob)
)
pred.qc$Risk = factor(pred.qc$Risk, levels=c('Low','Moderate','High'), ordered = T)

norm.pred = subset(pred.qc, SampleType != 'BE')

pred.qc = subset(pred.qc, SampleType == 'BE')

roc = pROC::roc(Status ~ Prob, data=pred.qc, auc=T, ci=T, of='thresholds')
roc.plot(roc) + labs(title='All, Prob')
pander(pROC::coords(roc, 'best'), caption='All samples, ROC best')

# Exclude HGD NP patients
roc = pROC::roc(Status ~ Prob, data=subset(pred.qc, !exclude), auc=T, ci=T, of='thresholds')
roc.plot(roc) + labs(title='Excluded HGD NP patients')

# Exclude the WGD NP
rocpp = pROC::roc(Status ~ Prob, data=subset(pred.qc, !wgd), auc=T, ci=T, of='thresholds')
roc.plot(rocpp) + labs(title='Both endos - excluded WGD NP')
pROC::coords(rocpp, 'best')

roc = pROC::roc(Status ~ Prob, data=subset(pred.qc, !exclude & !wgd), auc=T, ci=T, of='thresholds')
roc.plot(roc) + labs(title='Excluded HGD & WGD NP patients')

# Exclude the low SCA patients
rocpp = pROC::roc(Status ~ Prob, data=subset(pred.qc, !lowsca), auc=T, ci=T, of='thresholds')
roc.plot(rocpp) + labs(title='Both endos - excluded low SCA')
pROC::coords(rocpp, 'best')

# Exclude all of the above
rocpp = pROC::roc(Status ~ Prob, data=subset(pred.qc, !exclude & !lowsca & !wgd), auc=T, ci=T, of='thresholds')
roc.plot(rocpp) + labs(title='Both endos - excluded low SCA P & HGD NP & WGD NP')
pROC::coords(rocpp, 'best')


# Timepoint 2 only
roct2 = pROC::roc(Status ~ Prob, data=subset(pred.qc, Timepoint != 'T1' & !exclude & !lowsca & !wgd), auc=T, ci=T, of='thresholds')
roc.plot(roct2) + labs(title='T2, Prob')


ggplot(subset(pred.qc, !exclude & !wgd & !lowsca), aes(ASCAT.SCA.ratio_mean,Prob, color=Risk, shape=Status)) + 
  facet_grid(~Status) + geom_point()


ex.pred = subset(pred.qc, !exclude & !wgd & !lowsca)

write.table(subset(pred.qc, lowsca, select=c('PatientID','EndoID','Status','ASCAT.SCA.ratio_mean','SCA.Ratio_mean','Purity_mean')),
            sep='\t', quote=F, row.names=F, file='lowsca_pts.txt')


head(qcdata)

x = subset(qcdata, ASCAT.SCA.ratio < 0.02 & Purity > 0.95)
table(x$SampleType)/table(qcdata$SampleType)

write.table(subset(x, SampleType == 'BE', select=c('PatientID','EndoID','Samplename','ASCAT.SCA.ratio','SCA.Ratio','Purity')), quote=F, sep='\t', row.names = F, file='lowsca_samples.txt')

#x = subset(qcdata, ASCAT.SCA.ratio < 0.02 & Purity > 0.95 & SampleType == 'BE')


# Quick check
# nrow(subset(ex.pred, Prob > 0.5 & Status == 'P'))/table(ex.pred$Status)['P']
# nrow(subset(ex.pred, Prob < 0.5 & Status == 'P'))/table(ex.pred$Status)['P'] #False negatives
# 
# nrow(subset(ex.pred, Prob > 0.5 & Status == 'NP'))/table(ex.pred$Status)['NP'] # False pos
# nrow(subset(ex.pred, Prob < 0.5 & Status == 'NP'))/table(ex.pred$Status)['NP'] #

ct = cor.test(pred.qc.ex$Prob, pred.qc.ex$ASCAT.SCA.ratio_mean)
ct2 = cor.test(pred.qc$Prob, pred.qc$ASCAT.SCA.ratio_mean)
```

The risk probability is correlated with the % of the genome that's been altered as identified by Xiahong, R=`r ct$estimate` and that's true even when no patients are excluded (R=`r ct2$estimate`).


# Regression using SNP Data

```{r regression, echo=F, message=F, eval=F}
folds = 10; splits = 5
## ----- All ----- ##
cache.dir = '~/Data/Ellie/Analysis/SNP/no-low/'
file = paste(cache.dir, 'all.pt.alpha.Rdata', sep='/')
if (file.exists(file)) {
 message(paste("loading", file))
 load(file, verbose=T)
 model.performance(performance.at.1se, coefs)$plot + labs(title='SNP CV models')
} else {
  warning("Run 'snp-regression.R' first")
}
#save(arrayDf,labels,patient.info, file=paste(cache.dir,'snp-models.Rdata',sep='/'))

#do.call(grid.arrange, c(plots))
```

```{r compare.coefs, echo=F, eval=F}
# Matching
snp.features = coefs$`0.5`

intersect(rownames(snp.features), rownames(features)) 

cxisft = grep('cx',rownames(snp.features))

length(which(rowSums(snp.features[,-1])/50 > 0.5))

snp.features = do.call(rbind.data.frame, c(strsplit(rownames(snp.features)[-cxisft], ':|-'), stringsAsFactors=F))
colnames(snp.features) = c('chr','start','end')

swgs.features = do.call(rbind.data.frame, c(strsplit(rownames(features), ':|-'), stringsAsFactors=F))
colnames(swgs.features) = c('chr','start','end')

snp.features = makeGRangesFromDataFrame(snp.features)
snp.features = snp.features[-which(width(snp.features) > 5e6)] # No arms

swgs.features = makeGRangesFromDataFrame(swgs.features)

dist = distanceToNearest(swgs.features,snp.features)

swgs.features[queryHits(dist)]
snp.features[subjectHits(dist)]

match = dist[elementMetadata(dist)$distance != 0]
elementMetadata(dist)$bins = round(elementMetadata(dist)$distance/5e6)

x1 = dist[elementMetadata(dist)$bins <= 2]

swgs.features[queryHits(x1)]
snp.features[subjectHits(x1)]
```


```{r loo, eval=F}


file = paste(cache.dir, 'loo.Rdata', sep='/')
if (file.exists(file)) {
  load(file, verbose=T)
} else {
  stop("Run snp-regression.R first")
}


snp.roc = pROC::roc(Status~Prediction,slabels, auc=T, ci=T, of='thresholds')
roc.plot(snp.roc, title="SNP LOO Model ROC")

ggplot(cbind.data.frame('performance'=performance.at.1se, 'type'='snp'), aes(y=performance, x=type, group=type,fill=type)) + 
  geom_boxplot(outlier.colour = NA, show.legend = F) + geom_jitter(width=0.2) + geom_label(data=cbind.data.frame('performance'=range(performance.at.1se), 'type'='snp'), aes(label=round(performance,2)), nudge_x=0.1) + theme_bw() + theme(legend.position = 'none') + labs(x='', y='Classification', title='LOO Performance SNP')


file = paste(cache.dir, 'all.pt.alpha.Rdata', sep='/')
load(file, verbose=T)

fit.snp = models$`1`

probs = predict(fit.snp, newx = dysplasia.df, s = performance.at.1se$`1`$lambda,type='response' )


swgs.pred.snp = cbind.data.frame('Prob'=probs[,1], 'Status'=swgs_labels[rownames(probs)])
ssroc = pROC::roc(Status~Prob, data=swgs.pred.snp, ci=T, auc=T, of='thresholds')
roc.plot(ssroc, title='sWGS prediction on SNP model')
```



